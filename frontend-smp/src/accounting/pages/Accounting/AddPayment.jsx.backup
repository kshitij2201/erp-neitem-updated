import React, { useState, useEffect } from "react";
import axios from "axios";

export default function AddPayment() {
  // Fee calculation constants
  const FEE_CONSTANTS = {
    TFWS: "TFWS",
    CASTE_CATEGORIES: {
      OPEN: "Open",
      OBC: "OBC",
      SC: "SC",
      ST: "ST",
      NT: "NT",
      VJNT: "VJNT",
      SBC: "SBC",
      RESERVED: ["SC", "ST", "NT", "VJNT", "SBC"],
    },
    GENDER: {
      MALE: "Male",
      FEMALE: "Female",
    },
    FEE_PERCENTAGES: {
      ZERO: 0,
      FIFTY: 50,
      HUNDRED: 100,
    },
  };

  // Function to calculate fee percentage based on student attributes
  const calculateFeePercentage = (student, caste) => {
    if (!student) return FEE_CONSTANTS.FEE_PERCENTAGES.HUNDRED;

    const studentCaste = caste || student.caste;

    // TFWS students get 0% fees regardless of gender or caste
    if (studentCaste === FEE_CONSTANTS.TFWS) {
      return FEE_CONSTANTS.FEE_PERCENTAGES.ZERO;
    }

    // Reserved categories (SC, ST, NT, VJNT, SBC) get 0% fees
    if (FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(studentCaste)) {
      return FEE_CONSTANTS.FEE_PERCENTAGES.ZERO;
    }

    // OBC students get 50% fees
    if (studentCaste === FEE_CONSTANTS.CASTE_CATEGORIES.OBC) {
      return FEE_CONSTANTS.FEE_PERCENTAGES.FIFTY;
    }

    // Open category students get 100% fees
    if (studentCaste === FEE_CONSTANTS.CASTE_CATEGORIES.OPEN) {
      return FEE_CONSTANTS.FEE_PERCENTAGES.HUNDRED;
    }

    // Default to 100% for other cases
    return FEE_CONSTANTS.FEE_PERCENTAGES.HUNDRED;
  };

  // Function to calculate actual fee amount based on base amount and percentage
  const calculateFeeAmount = (baseAmount, percentage) => {
    return (baseAmount * percentage) / 100;
  };
  const [formData, setFormData] = useState({
    studentId: "",
    amount: "",
    paymentMethod: "Bank Transfer",
    description: "",
    transactionId: "",
    utr: "",
    collectedBy: "",
    remarks: "",
    feeHead: "",
    academicYear: "2025-26",
    paymentType: "specific", // 'specific', 'multiple', 'annual', 'transport', 'hostel', 'library', 'lab', 'sports', 'development', 'salary', 'miscellaneous', 'admission', 'exam'
    selectedFeeHeads: [], // Array of selected fee head IDs for multiple payments
    // Manual fee entry fields
    manualFeeHeadName: "",
    manualFeeAmount: "",
    manualFeeDescription: "",
    manualFeeCategory: "",
    // Transport fee fields
    transportRoute: "",
    transportDuration: "",
    // Hostel fee fields
    hostelBlock: "",
    roomNumber: "",
    hostelFeeType: "",
    // Library fee fields
    libraryFeeType: "",
    libraryDetails: "",
    // Lab fee fields
    labType: "",
    labDuration: "",
    // Sports fee fields
    sportsActivity: "",
    sportsFeeType: "",
    // Miscellaneous fee fields
    miscellaneousPurpose: "",
    // Salary payment fields
    employeeName: "",
    employeeId: "",
    salaryType: "monthly", // 'monthly' or 'annual'
    salaryMonth: "",
    salaryYear: new Date().getFullYear().toString(),
    // Admission fee fields
    admissionType: "",
    admissionCategory: "",
    // Exam fee fields
    examType: "",
    examSemester: "",
    examSubjectCount: "",
    // TFWS field
    tfws: false,
    // Caste field
    caste: "",
  });

  const [students, setStudents] = useState([]);
  const [feeHeads, setFeeHeads] = useState([]);
  const [recentPayments, setRecentPayments] = useState([]);
  const [pendingFees, setPendingFees] = useState([]);
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState("");
  const [error, setError] = useState("");
  const [showReceipt, setShowReceipt] = useState(false);
  const [receiptData, setReceiptData] = useState(null);
  const [loadingStudents, setLoadingStudents] = useState(true);
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [studentSearchTerm, setStudentSearchTerm] = useState("");
  const [filteredSearchTerm, setFilteredSearchTerm] = useState("");
  const [highlightedIndex, setHighlightedIndex] = useState(-1);
  const [studentSearchTimeout, setStudentSearchTimeout] = useState(null);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [calculatedFee, setCalculatedFee] = useState({
    baseAmount: 0,
    percentage: 100,
    finalAmount: 0,
    category: "",
  });

  // Handle student search with debouncing for better UX
  const handleStudentSearch = (searchTerm) => {
    setStudentSearchTerm(searchTerm);
  };

  // Debounced search effect for better performance
  useEffect(() => {
    const debounceTimer = setTimeout(() => {
      setFilteredSearchTerm(studentSearchTerm);
    }, 300); // 300ms debounce

    return () => clearTimeout(debounceTimer);
  }, [studentSearchTerm]);

  // Load initial data on component mount
  useEffect(() => {
    fetchStudents();
    fetchFeeHeads();
    fetchRecentPayments();
  }, []);

  // Filtered students based on debounced search term
  const filteredStudents = students.filter((student) => {
    if (!filteredSearchTerm) return true;
    const searchLower = filteredSearchTerm.toLowerCase();
    return (
      student.firstName?.toLowerCase().includes(searchLower) ||
      student.lastName?.toLowerCase().includes(searchLower) ||
      student.studentId?.toLowerCase().includes(searchLower) ||
      (typeof student.department === "object"
        ? student.department?.name?.toLowerCase().includes(searchLower)
        : student.department?.toLowerCase().includes(searchLower)) ||
      student.currentSemester?.toString().includes(searchLower) ||
      (student.caste || student.casteCategory || '').toLowerCase().includes(searchLower)
    );
  });

  // Helper function to get student gender
  const getStudentGender = (student) => {
    if (!student) return null;
    return student.gender || student.sex || null;
  };

  // Handle student selection from dropdown
  const handleStudentSelect = (student) => {
    setFormData((prev) => ({
      ...prev,
      studentId: student._id,
    }));
    setSelectedStudent(student);
    setIsDropdownOpen(false);
    setStudentSearchTerm("");
    setHighlightedIndex(-1);
    fetchPendingFees(student._id);
  };

  // Generate academic years for selection
  const generateAcademicYears = () => {
    const currentYear = new Date().getFullYear();
    const years = [];

    // Generate 5 years: current-2 to current+2
    for (let i = -2; i <= 2; i++) {
      const startYear = currentYear + i;
      const endYear = startYear + 1;
      const yearCode = `${startYear.toString().slice(-2)}-${endYear
        .toString()
        .slice(-2)}`;
      years.push({
        value: yearCode,
        label: `${startYear}-${endYear}`,
        isCurrent: i === 0,
      });
    }

    return years;
  };

  const academicYears = generateAcademicYears();

  const fetchStudents = async (searchTerm = "", page = 1, limit = 1061) => {
    setLoadingStudents(true);
    try {
      const token = localStorage.getItem("token");
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      // Build query parameters
      const params = new URLSearchParams({
        page: page.toString(),
        limit: limit.toString(),
      });

      if (searchTerm && searchTerm.trim()) {
        params.append("search", searchTerm.trim());
      }

      // Fetch students with search and pagination
      const response = await axios.get(
        `http://localhost:4000/api/students?${params.toString()}`,
        { headers }
      );

      // Handle different response formats
      let studentData = [];
      let totalCount = 0;

      if (Array.isArray(response.data)) {
        studentData = response.data;
        totalCount = response.data.length;
      } else if (response.data && Array.isArray(response.data.data)) {
        studentData = response.data.data;
        totalCount = response.data.total || response.data.data.length;
      } else if (response.data && Array.isArray(response.data.students)) {
        studentData = response.data.students;
        totalCount = response.data.total || response.data.students.length;
      }

      console.log(
        `Fetched ${studentData.length} students (page ${page}, search: "${searchTerm}")`
      );

      // Sort students by name in ascending order
      const sortedStudents = studentData.sort((a, b) => {
        const nameA = `${a.firstName || ""} ${a.lastName || ""}`
          .toLowerCase()
          .trim();
        const nameB = `${b.firstName || ""} ${b.lastName || ""}`
          .toLowerCase()
          .trim();
        return nameA.localeCompare(nameB);
      });

      // If this is the first page and no search term, store all students
      // If there's a search term, replace the current list
      if (page === 1) {
        setStudents(sortedStudents);
      } else {
        // For pagination, append to existing list
        setStudents((prev) => [...prev, ...sortedStudents]);
      }

      // Store total count for pagination
      setStudents((prev) =>
        prev.map((student) => ({ ...student, totalCount }))
      );

      setLoadingStudents(false);
      console.log("Students loaded successfully:", sortedStudents.length);
    } catch (err) {
      console.error("Error fetching students:", err);
      setStudents([]);
      setLoadingStudents(false);

      // Provide more detailed error messages
      let errorMessage = "Failed to load students. ";

      if (err.response) {
        // The request was made and the server responded with a status code
        // that falls out of the range of 2xx
        if (err.response.status === 500) {
          errorMessage +=
            "The server encountered an error. Please contact the system administrator or try again later.";
        } else if (err.response.status === 404) {
          errorMessage += "Student data endpoint not found. Please check the backend configuration.";
        } else if (err.response.status === 401 || err.response.status === 403) {
          errorMessage += "You do not have permission to access student data. Please log in again.";
        } else {
          errorMessage += `Server error (${err.response.status}): ${err.response.data?.message || err.message}`;
        }
      } else if (err.request) {
        // The request was made but no response was received
        errorMessage += "Cannot connect to the server. Please check your internet connection and ensure the backend server is running.";
      } else {
        // Something happened in setting up the request that triggered an Error
        errorMessage += `Error: ${err.message}`;
      }

      setError(errorMessage);

      // Optional: Show a user-friendly toast/notification instead of just console error
      // You can add a toast library if needed
    }
  };

  const fetchFeeHeads = async () => {
    try {
      const token = localStorage.getItem("token");
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      const response = await axios.get(
        "http://localhost:4000/api/fee-heads",
        {
          headers,
        }
      );
      // Remove duplicates based on title and sort in ascending order
      const feeHeadsData = Array.isArray(response.data) ? response.data : [];
      const uniqueFeeHeads = feeHeadsData.filter(
        (head, index, self) =>
          head && head.title && typeof head.title === 'string' &&
          index ===
          self.findIndex(
            (h) => h && h.title && typeof h.title === 'string' &&
                   h.title.toLowerCase() === head.title.toLowerCase()
          )
      );
      const sortedFeeHeads = uniqueFeeHeads.sort((a, b) => {
        if (!a || !a.title || typeof a.title !== 'string') return 1;
        if (!b || !b.title || typeof b.title !== 'string') return -1;
        return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
      });
      setFeeHeads(sortedFeeHeads);
    } catch (err) {
      console.error("Error fetching fee heads:", err);
      // Set empty array instead of using mock data
      setFeeHeads([]);
      setError(
        "Failed to load fee heads. Please ensure fee heads are properly configured."
      );
    }
  };

  const fetchRecentPayments = async () => {
    try {
      const token = localStorage.getItem("token");
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      const response = await axios.get(
        "http://localhost:4000/api/payments?limit=50",
        { headers }
      );
      setRecentPayments(Array.isArray(response.data) ? response.data : []);
    } catch (err) {
      console.error("Error fetching recent payments:", err);
      // Set empty array instead of using mock data
      setRecentPayments([]);
    }
  };

  const fetchPendingFees = async (studentId) => {
    if (!studentId) {
      setPendingFees([]);
      return;
    }

    try {
      const token = localStorage.getItem("token");
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      const response = await axios.get(
        `http://localhost:4000/api/students/${studentId}/pending-fees?academicYear=${formData.academicYear}`,
        { headers }
      );
      setPendingFees(response.data || []);
    } catch (err) {
      console.error("Error fetching pending fees:", err);
      // Calculate pending fees manually without API dependency
      calculatePendingFees(studentId);
    }
  };

  const calculatePendingFees = async (studentId) => {
    try {
      // Get student's payment history
      const token = localStorage.getItem("token");
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      const paymentsResponse = await axios.get(
        `http://localhost:4000/api/payments?studentId=${studentId}`,
        { headers }
      );
      const payments = paymentsResponse.data || [];

      // Calculate pending fees based on fee heads and payments
      const pendingFeesCalc = feeHeads
        .map((feeHead) => {
          const totalPaid = payments
            .filter((payment) => payment.feeHead === feeHead._id)
            .reduce((sum, payment) => sum + payment.amount, 0);

          const pendingAmount = feeHead.amount - totalPaid;

          if (pendingAmount > 0) {
            return {
              feeHead: feeHead.title,
              feeHeadId: feeHead._id,
              totalAmount: feeHead.amount,
              paidAmount: totalPaid,
              pendingAmount: pendingAmount,
              dueDate: feeHead.dueDate || null,
            };
          }
          return null;
        })
        .filter((fee) => fee !== null);

      setPendingFees(pendingFeesCalc);
    } catch (err) {
      console.error("Error calculating pending fees:", err);
      setPendingFees([]);
    }
  };

  const checkForDuplicatePayment = () => {
    const currentTime = new Date();
    const fiveMinutesAgo = new Date(currentTime.getTime() - 5 * 60 * 1000);

    const possibleDuplicate = recentPayments.find((payment) => {
      const paymentTime = new Date(payment.date || payment.createdAt);
      return (
        payment.studentId === formData.studentId &&
        payment.amount === parseFloat(formData.amount) &&
        payment.paymentMethod === formData.paymentMethod &&
        paymentTime >= fiveMinutesAgo
      );
    });

    return possibleDuplicate;
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
      // Clear selected fee heads when changing payment type
      ...(name === "paymentType" && { selectedFeeHeads: [] }),
    }));

    // Fetch pending fees when student is selected
    if (name === "studentId" && value) {
      fetchPendingFees(value);
    } else if (name === "studentId" && !value) {
      setPendingFees([]);
    }

    // Update calculated fee when amount changes
    if (name === "amount" && selectedStudent) {
      const baseAmount = parseFloat(value) || 0;
      const finalAmount = calculateFeeAmount(baseAmount, calculatedFee.percentage);
      setCalculatedFee((prev) => ({
        ...prev,
        baseAmount: baseAmount,
        finalAmount: finalAmount,
      }));
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError("");
    setSuccess("");

    try {
      // Only validate student ID for non-salary payments
      if (formData.paymentType !== "salary" && !formData.studentId) {
        setError("Please select a student");
        setLoading(false);
        return;
      }

      // Check for duplicate payment
      const duplicatePayment = checkForDuplicatePayment();
      if (duplicatePayment) {
        setError(
          "âš ï¸ Duplicate Payment Detected! A similar payment for this student with same amount and method was made within last 5 minutes. Please verify before proceeding."
        );
        setLoading(false);
        return;
      }

      const paymentData = {
        amount: parseFloat(formData.amount),
        paymentMethod: formData.paymentMethod,
        description:
          formData.description ||
          `${
            formData.paymentType === "salary"
              ? "Salary"
              : formData.paymentType === "multiple"
              ? "Multiple Fee"
              : formData.paymentType === "annual"
              ? "Annual Fee"
              : formData.paymentType === "transport"
              ? "Transport Fee"
              : formData.paymentType === "hostel"
              ? "Hostel Fee"
              : formData.paymentType === "library"
              ? "Library Fee"
              : formData.paymentType === "lab"
              ? "Lab Fee"
              : formData.paymentType === "sports"
              ? "Sports Fee"
              : formData.paymentType === "development"
              ? "Development Fee"
              : formData.paymentType === "miscellaneous"
              ? "Miscellaneous Fee"
              : formData.paymentType === "admission"
              ? "Admission Fee"
              : formData.paymentType === "exam"
              ? "Exam Fee"
              : "Fee"
          } Payment`,
        transactionId: formData.transactionId || "",
        collectedBy: formData.collectedBy || "",
        remarks: formData.remarks || "",
        type: formData.paymentType === "salary" ? "salary" : "student",
        paymentType: formData.paymentType,
        academicYear: formData.academicYear,
      };

      // Add UTR for digital payment methods (except for reserved category students or female students)
      if (
        ["Online", "Bank Transfer", "Card", "UPI"].includes(formData.paymentMethod) &&
        !FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) &&
        selectedStudent?.gender !== "Female"
      ) {
        console.log("ðŸ” UTR Debug - Payment Method:", formData.paymentMethod);
        console.log("ðŸ” UTR Debug - formData.utr value:", formData.utr);
        console.log("ðŸ” UTR Debug - formData.utr type:", typeof formData.utr);

        if (!formData.utr || formData.utr.trim() === "") {
          setError(
            "UTR number is required for digital payment methods (Online, Bank Transfer, Card, UPI)"
          );
          setLoading(false);
          return;
        }
        paymentData.utr = formData.utr.trim();
        console.log("ðŸ” UTR Debug - paymentData.utr (to be sent):", paymentData.utr);
      }

      // Validate admission and exam specific fields
      if (formData.paymentType === "admission") {
        if (!formData.admissionType || !formData.admissionCategory) {
          setError("Admission type and category are required for admission fees");
          setLoading(false);
          return;
        }
      } else if (formData.paymentType === "exam") {
        if (!formData.examType || !formData.examSemester || !formData.examSubjectCount) {
          setError("Exam type, semester, and subject count are required for exam fees");
          setLoading(false);
          return;
        }
      }

      // Add type-specific data
      if (formData.paymentType === "salary") {
        paymentData.employeeName = formData.employeeName;
        paymentData.employeeId = formData.employeeId;
        paymentData.salaryType = formData.salaryType;
        paymentData.salaryYear = formData.salaryYear;
        if (formData.salaryType === "monthly" && formData.salaryMonth) {
          paymentData.salaryMonth = formData.salaryMonth;
        }
      } else {
        paymentData.studentId = formData.studentId;
        if (formData.feeHead) {
          paymentData.feeHead = formData.feeHead;
        }
        // Add multiple fee heads for multiple payment type
        if (
          formData.paymentType === "multiple" &&
          formData.selectedFeeHeads.length > 0
        ) {
          paymentData.multipleFeeHeads = formData.selectedFeeHeads;
        }
        // Add admission specific data
        if (formData.paymentType === "admission") {
          paymentData.admissionType = formData.admissionType;
          paymentData.admissionCategory = formData.admissionCategory;
        }
        // Add exam specific data
        if (formData.paymentType === "exam") {
          paymentData.examType = formData.examType;
          paymentData.examSemester = formData.examSemester;
          paymentData.examSubjectCount = formData.examSubjectCount;
        }
      }

      const token = localStorage.getItem("token");
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      console.log("ðŸ“¤ Sending payment data to API:", JSON.stringify(paymentData, null, 2));

      const response = await axios.post(
        "http://localhost:4000/api/payments",
        paymentData,
        { headers }
      );

      console.log("ðŸ“¥ API Response:", response.data);

      if (response.data) {
        let paymentTypeText = "";
        let successMessage = "";

        if (formData.paymentType === "salary") {
          paymentTypeText = `${formData.salaryType} salary for ${
            formData.salaryType === "monthly"
              ? `${getMonthName(formData.salaryMonth)} ${formData.salaryYear}`
              : formData.salaryYear
          }`;
          successMessage = `Salary payment of â‚¹${formData.amount} for ${formData.employeeName} (${paymentTypeText}) recorded successfully! Receipt: ${response.data.payment.receiptNumber}`;
        } else {
          if (formData.paymentType === "multiple") {
            paymentTypeText = `(${formData.selectedFeeHeads.length} fee heads)`;
          } else {
            const paymentTypeMap = {
              annual: "(Annual Payment)",
              transport: "(Transport Fees)",
              hostel: "(Hostel Fees)",
              library: "(Library Fees)",
              lab: "(Lab Fees)",
              sports: "(Sports Fees)",
              development: "(Development Fees)",
              miscellaneous: "(Miscellaneous Fees)",
              admission: "(Admission Fees)",
              exam: "(Exam Fees)",
              specific: "",
            };
            paymentTypeText = paymentTypeMap[formData.paymentType] || "";
          }
          successMessage = `Student fee payment of â‚¹${formData.amount} ${paymentTypeText} recorded successfully! Receipt: ${response.data.payment.receiptNumber}`;
        }

        // Store receipt data
        let receipt = {
          receiptNumber: response.data.payment.receiptNumber,
          date: new Date().toLocaleDateString(),
          time: new Date().toLocaleTimeString(),
          amount: formData.amount,
          paymentMethod: formData.paymentMethod,
          description:
            formData.description ||
            `${
              formData.paymentType === "semester"
                ? "Semester"
                : formData.paymentType === "salary"
                ? "Salary"
                : formData.paymentType === "multiple"
                ? "Multiple Fee"
                : formData.paymentType === "annual"
                ? "Annual Fee"
                : formData.paymentType === "transport"
                ? "Transport Fee"
                : formData.paymentType === "hostel"
                ? "Hostel Fee"
                : formData.paymentType === "library"
                ? "Library Fee"
                : formData.paymentType === "lab"
                ? "Lab Fee"
                : formData.paymentType === "sports"
                ? "Sports Fee"
                : formData.paymentType === "development"
                ? "Development Fee"
                : formData.paymentType === "miscellaneous"
                ? "Miscellaneous Fee"
                : formData.paymentType === "admission"
                ? "Admission Fee"
                : formData.paymentType === "exam"
                ? "Exam Fee"
                : "Fee"
            } Payment`,
          transactionId: formData.transactionId,
          collectedBy: formData.collectedBy,
          remarks: formData.remarks,
          paymentType: formData.paymentType,
          academicYear: formData.academicYear,
        };

        // Add UTR for digital payment methods
        if (["Online", "Bank Transfer", "Card", "UPI"].includes(formData.paymentMethod)) {
          receipt.utr = formData.utr;
        }

        if (formData.paymentType === "salary") {
          receipt.employeeName = formData.employeeName;
          receipt.employeeId = formData.employeeId;
          receipt.salaryType = formData.salaryType;
          receipt.salaryYear = formData.salaryYear;
          if (formData.salaryType === "monthly") {
            receipt.salaryMonth = formData.salaryMonth;
            receipt.salaryMonthName = getMonthName(formData.salaryMonth);
          }
        } else {
          const selectedStudent = students.find(
            (s) => s._id === formData.studentId
          );
          const selectedFeeHead = feeHeads.find(
            (f) => f._id === formData.feeHead
          );
          receipt.student = selectedStudent;
          receipt.feeHead = selectedFeeHead;

          // Add admission specific data to receipt
          if (formData.paymentType === "admission") {
            receipt.admissionType = formData.admissionType;
            receipt.admissionCategory = formData.admissionCategory;
          }
          // Add exam specific data to receipt
          if (formData.paymentType === "exam") {
            receipt.examType = formData.examType;
            receipt.examSemester = formData.examSemester;
            receipt.examSubjectCount = formData.examSubjectCount;
          }

          // Set appropriate fee head name based on payment type
          if (!selectedFeeHead) {
            // Create a descriptive fee head based on payment type
            const paymentTypeDescriptions = {
              multiple: "Multiple Fee Heads Payment",
              annual: `Annual Fees (${formData.academicYear})`,
              transport: formData.transportRoute
                ? `Transport Fees - ${formData.transportRoute} (${
                    formData.transportDuration || "Route"
                  })`
                : "Transport Fees",
              hostel: formData.hostelBlock
                ? `Hostel Fees - Block ${formData.hostelBlock}${
                    formData.roomNumber ? ", Room " + formData.roomNumber : ""
                  }${
                    formData.hostelFeeType
                      ? " (" + formData.hostelFeeType + ")"
                      : ""
                  }`
                : "Hostel Fees",
              library: formData.libraryFeeType
                ? `Library Fees - ${formData.libraryFeeType}${
                    formData.libraryDetails
                      ? " (" + formData.libraryDetails + ")"
                      : ""
                  }`
                : "Library Fees",
              lab: formData.labType
                ? `Laboratory Fees - ${formData.labType} Lab${
                    formData.labDuration
                      ? " (" + formData.labDuration + ")"
                      : ""
                  }`
                : "Laboratory Fees",
              sports: formData.sportsActivity
                ? `Sports Fees - ${formData.sportsActivity}${
                    formData.sportsFeeType
                      ? " (" + formData.sportsFeeType + ")"
                      : ""
                  }`
                : "Sports Fees",
              development: "Development Fees - Infrastructure Development",
              miscellaneous:
                formData.miscellaneousPurpose || "Miscellaneous Fees",
              admission: formData.admissionType && formData.admissionCategory
                ? `Admission Fees - ${formData.admissionType} (${formData.admissionCategory})`
                : "Admission Fees",
              exam: formData.examType && formData.examSemester && formData.examSubjectCount
                ? `Exam Fees - ${formData.examType} (${formData.examSemester}, ${formData.examSubjectCount} subjects)`
                : "Exam Fees",
            };

            receipt.feeHead = {
              title:
                paymentTypeDescriptions[formData.paymentType] ||
                "General Fee Payment",
              amount: parseInt(formData.amount),
            };
          }

          // Add detailed fee type information to receipt
          receipt.feeTypeDetails = {};
          if (formData.paymentType === "specific") {
            // For manual fee entry
            receipt.feeTypeDetails = {
              manualFeeHeadName: formData.manualFeeHeadName,
              manualFeeAmount: formData.manualFeeAmount,
              manualFeeDescription: formData.manualFeeDescription,
              manualFeeCategory: formData.manualFeeCategory,
              category: formData.manualFeeCategory || "Specific Fee Payment",
            };
          } else if (formData.paymentType === "transport") {
            receipt.feeTypeDetails = {
              route: formData.transportRoute,
              duration: formData.transportDuration,
              category: "Transport Services",
            };
          } else if (formData.paymentType === "hostel") {
            receipt.feeTypeDetails = {
              block: formData.hostelBlock,
              roomNumber: formData.roomNumber,
              feeType: formData.hostelFeeType,
              category: "Hostel Services",
            };
          } else if (formData.paymentType === "library") {
            receipt.feeTypeDetails = {
              feeType: formData.libraryFeeType,
              details: formData.libraryDetails,
              category: "Library Services",
            };
          } else if (formData.paymentType === "lab") {
            receipt.feeTypeDetails = {
              labType: formData.labType,
              duration: formData.labDuration,
              category: "Laboratory Services",
            };
          } else if (formData.paymentType === "sports") {
            receipt.feeTypeDetails = {
              activity: formData.sportsActivity,
              feeType: formData.sportsFeeType,
              category: "Sports Services",
            };
          } else if (formData.paymentType === "development") {
            receipt.feeTypeDetails = {
              category: "Infrastructure Development",
              purpose: "Building and facility development",
            };
          } else if (formData.paymentType === "miscellaneous") {
            receipt.feeTypeDetails = {
              purpose: formData.miscellaneousPurpose,
              category: "Miscellaneous Services",
            };
          } else if (formData.paymentType === "admission") {
            receipt.feeTypeDetails = {
              admissionType: formData.admissionType,
              admissionCategory: formData.admissionCategory,
              category: "Admission Services",
            };
          } else if (formData.paymentType === "exam") {
            receipt.feeTypeDetails = {
              examType: formData.examType,
              semester: formData.examSemester,
              subjectCount: formData.examSubjectCount,
              category: "Examination Services",
            };
          }

          // Add fee breakdown for better receipt display
          if (
            formData.paymentType === "multiple" &&
            formData.selectedFeeHeads.length > 0
          ) {
            // For multiple fee payment, add the selected fee heads data
            const selectedFeesData = formData.selectedFeeHeads
              .map((feeHeadId) => {
                const pendingFee = pendingFees.find(
                  (f) => f.feeHeadId === feeHeadId
                );
                if (pendingFee) {
                  return {
                    feeHead: pendingFee.feeHead,
                    feeHeadId: pendingFee.feeHeadId,
                    totalAmount: pendingFee.totalAmount,
                    paidAmount: pendingFee.paidAmount,
                    currentPayment: pendingFee.pendingAmount,
                    balance: 0,
                  };
                }
                return null;
              })
              .filter(Boolean);
            receipt.multipleFees = selectedFeesData;
          } else if (
            formData.paymentType === "specific" &&
            pendingFees.length > 0
          ) {
            // For specific payment, check if multiple pending fees could be covered
            const totalAmount = parseInt(formData.amount);
            let remainingAmount = totalAmount;
            const paidFees = [];

            // Sort pending fees by amount (smallest first for better allocation)
            const sortedPendingFees = [...pendingFees].sort(
              (a, b) => a.pendingAmount - b.pendingAmount
            );

            for (const fee of sortedPendingFees) {
              if (remainingAmount >= fee.pendingAmount) {
                paidFees.push({
                  feeHead: fee.feeHead,
                  feeHeadId: fee.feeHeadId,
                  totalAmount: fee.totalAmount,
                  paidAmount: fee.paidAmount,
                  currentPayment: fee.pendingAmount,
                  balance: 0,
                });
                remainingAmount -= fee.pendingAmount;
              } else if (remainingAmount > 0) {
                paidFees.push({
                  feeHead: fee.feeHead,
                  feeHeadId: fee.feeHeadId,
                  totalAmount: fee.totalAmount,
                  paidAmount: fee.paidAmount,
                  currentPayment: remainingAmount,
                  balance: fee.pendingAmount - remainingAmount,
                });
                remainingAmount = 0;
                break;
              }
            }

            // If there are multiple fees or partial payment, use this breakdown
            if (paidFees.length > 0) {
              receipt.multipleFees = paidFees;
            }
          }
        }

        // Ensure fee head information is always available for receipt display
        if (!receipt.multipleFees && !receipt.feeHead) {
          receipt.feeHead = {
            title: `${receipt.paymentType.charAt(0).toUpperCase() + receipt.paymentType.slice(1)} Fee Payment`,
            amount: parseInt(formData.amount),
          };
        }

        setReceiptData(receipt);
        setShowReceipt(true);
        setSuccess(
          `Student fee payment of â‚¹${formData.amount} ${paymentTypeText} recorded successfully! Receipt: ${response.data.payment.receiptNumber}`
        );

        // Refresh data
        fetchRecentPayments();
        if (formData.studentId) {
          fetchPendingFees(formData.studentId);
        }

        // Reset form
        setFormData({
          studentId: "",
          amount: "",
          paymentMethod: "Bank Transfer",
          description: "",
          transactionId: "",
          collectedBy: "",
          remarks: "",
          feeHead: "",
          semester: "",
          academicYear: "2025-26",
          paymentType: "specific",
          selectedFeeHeads: [],
          // Manual fee entry fields
          manualFeeHeadName: "",
          manualFeeAmount: "",
          manualFeeDescription: "",
          manualFeeCategory: "",
          // Transport fee fields
          transportRoute: "",
          transportDuration: "",
          // Hostel fee fields
          hostelBlock: "",
          roomNumber: "",
          hostelFeeType: "",
          // Library fee fields
          libraryFeeType: "",
          libraryDetails: "",
          // Lab fee fields
          labType: "",
          labDuration: "",
          // Sports fee fields
          sportsActivity: "",
          sportsFeeType: "",
          // Miscellaneous fee fields
          miscellaneousPurpose: "",
          // Salary payment fields
          employeeName: "",
          employeeId: "",
          salaryType: "monthly",
          salaryMonth: "",
          salaryYear: new Date().getFullYear().toString(),
        });
        setPendingFees([]);
      }
    } catch (err) {
      console.error("Payment error:", err);
      setError(err.response?.data?.message || "Failed to record payment");
    } finally {
      setLoading(false);
    }
  };

  const clearForm = () => {
    setFormData({
      studentId: "",
      amount: "",
      paymentMethod: "Bank Transfer", // Always set a default payment method
      description: "",
      transactionId: "",
      utr: "",
      collectedBy: "",
      remarks: "",
      feeHead: "",
      semester: "",
      academicYear: "2025-26",
      paymentType: "specific",
      selectedFeeHeads: [],
      // Manual fee entry fields
      manualFeeHeadName: "",
      manualFeeAmount: "",
      manualFeeDescription: "",
      manualFeeCategory: "",
      // Transport fee fields
      transportRoute: "",
      transportDuration: "",
      // Hostel fee fields
      hostelBlock: "",
      roomNumber: "",
      hostelFeeType: "",
      // Library fee fields
      libraryFeeType: "",
      libraryDetails: "",
      // Lab fee fields
      labType: "",
      labDuration: "",
      // Sports fee fields
      sportsActivity: "",
      sportsFeeType: "",
      // Miscellaneous fee fields
      miscellaneousPurpose: "",
      // Salary payment fields
      employeeName: "",
      employeeId: "",
      salaryType: "monthly",
      salaryMonth: "",
      salaryYear: new Date().getFullYear().toString(),
      // Admission fee fields
      admissionType: "",
      admissionCategory: "",
      // Exam fee fields
      examType: "",
      examSemester: "",
      examSubjectCount: "",
      // TFWS field
      tfws: false,
      // Caste field
      caste: "",
    });
    setError("");
    setSuccess("");
    setPendingFees([]);
    setSelectedStudent(null);
    setCalculatedFee({
      baseAmount: 0,
      percentage: 100,
      finalAmount: 0,
      category: "",
    });
  };

  // Receipt Modal Component
  const ReceiptModal = () => {
    if (!showReceipt || !receiptData) return null;

    const printReceipt = () => {
      // Function to generate single receipt with label
      const generateReceipt = (label) => `
            <div class="receipt-container">
              <div class="receipt-header-box">
                <div class="duplicate-label">${label}</div>
                <div class="institute-header-simple">
                  <div class="logo-left">
                    <img src="/logo1.png" alt="Logo" />
                  </div>
                  <div class="header-text">
                    <div class="society-name-simple">Maitrey Educational Society's</div>
                    <div class="institute-name-simple">NAGARJUNA INSTITUTE OF ENGINEERING, TECHNOLOGY & MANAGEMENT</div>
                    <div class="institute-address-simple">Village Satnavri, Amravati Road, Nagpur - 440023</div>
                  </div>
                  <div class="logo-right">
                    <img src="/logo.png" alt="Logo" />
                  </div>
                </div>
              </div>
              
              <div class="receipt-type-label">EAXM (OTHER FEES RECEIPT)</div>

              <div class="receipt-info-header">
                <div class="receipt-info-left">
                  <div class="info-item"><span class="label">Rec. No.:</span> <span class="value">${receiptData.receiptNumber}</span></div>
                  <div class="info-item"><span class="label">Class:</span> <span class="value">${receiptData.student?.program || 'N/A'}</span></div>
                  <div class="info-item"><span class="label">Category:</span> <span class="value">${receiptData.student?.caste || 'N/A'}</span></div>
                  <div class="info-item"><span class="label">Name:</span> <span class="value">${receiptData.student?.firstName} ${receiptData.student?.lastName}</span></div>
                </div>
                <div class="receipt-info-center">
                </div>
                <div class="receipt-info-right">
                  <div class="info-item"><span class="label">Date:</span> <span class="value">${receiptData.date}</span></div>
                  <div class="info-item"><span class="label">Adm. No.:</span> <span class="value">${receiptData.student?.admissionNumber || receiptData.student?.studentId}</span></div>
                  <div class="info-item"><span class="label">Student Id.:</span> <span class="value">${receiptData.student?.studentId}</span></div>
                  <div class="info-item"><span class="label">Fee Type:</span> <span class="value">${receiptData.paymentType.toUpperCase()}</span></div>
                </div>
              </div>
              
              <div class="received-section">
                <div class="received-label">Received the following:</div>
                <div class="amount-label">(â‚¹)Amount</div>
              </div>
              
              <div class="fee-details-table">
                <table>
                  <tbody>
                    ${
                      receiptData.multipleFees && receiptData.multipleFees.length > 0
                        ? receiptData.multipleFees
                            .map(
                              (fee, index) => `
                        <tr>
                          <td class="fee-name">${fee.feeHead}</td>
                          <td class="fee-amount">${fee.currentPayment.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        </tr>
                      `
                            )
                            .join("")
                        : `
                        <tr>
                          <td class="fee-name">${receiptData.feeHead?.title || receiptData.description || 'Fee Payment'}</td>
                          <td class="fee-amount">${parseInt(receiptData.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        </tr>
                      `
                    }
                  </tbody>
                </table>
              </div>
              
              <div class="logo-section">
                <img src="/logo.png" alt="NIETM Logo" class="center-logo" />
              </div>
              
              <div class="total-section">
                <div class="total-label">Total :</div>
                <div class="total-amount">â‚¹ ${parseInt(receiptData.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
              </div>
              
              <div class="amount-in-words">
                <span class="words-label">In words:</span> ${numberToWords(parseInt(receiptData.amount))} Only
              </div>
              
              <div class="payment-details-footer">
                <div class="payment-info">Med : ${receiptData.description || 'N/A'}</div>
                ${receiptData.paymentMethod === 'UPI' || receiptData.paymentMethod === 'Online' ? `
                <div class="payment-info">UPI Amount : ${parseInt(receiptData.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bank Info = Transaction ID : ${receiptData.transactionId || 'N/A'}, Date : ${receiptData.date}</div>
                <div class="payment-info">Bank Name : ${receiptData.bankName || 'N/A'}, Location : ${receiptData.bankLocation || 'N/A'}</div>
                ` : ''}
                <div class="payment-info">Remarks : ${receiptData.remarks || receiptData.description || 'Payment Received'}</div>
              </div>
              
              <div class="footer-signature">
                <div class="cashier-info">O1-${receiptData.collectedBy || 'Cashier'}/${receiptData.date}</div>
                <div class="cashier-name">${receiptData.collectedBy || 'Cashier Name'}</div>
                <div class="signature-label">RECEIVER'S SIGNATURE</div>
              </div>
              
              <div class="page-number">Page 1 of 1</div>
            </div>
      `;

      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Fee Payment Receipt - ${receiptData.receiptNumber}</title>
          <style>
            @page {
              size: A4;
              margin: 10mm;
            }
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body { 
              font-family: Arial, sans-serif; 
              margin: 0; 
              padding: 5px; 
              background: white;
              line-height: 1.4;
              color: #000;
              font-size: 9px;
            }
            .receipts-wrapper {
              display: flex;
              flex-direction: row;
              gap: 8px;
              width: 100%;
              justify-content: space-between;
              height: 100%;
            }
            .receipt-container {
              width: 49%;
              border: 1px solid #000;
              background: white;
              padding: 12px;
              page-break-inside: avoid;
              min-height: 800px;
              height: auto;
              display: flex;
              flex-direction: column;
              justify-content: space-between;
            }
            .receipt-header-box {
              border: 1px solid #000;
              padding: 10px;
              margin-bottom: 12px;
              position: relative;
            }
            .duplicate-label {
              position: absolute;
              top: 3px;
              right: 8px;
              font-weight: bold;
              font-size: 10px;
              text-transform: uppercase;
              margin-bottom: 10px;
            }
            .institute-header-simple {
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 5px;
            }
            .logo-left, .logo-right {
              width: 35px;
              height: 35px;
              flex-shrink: 0;
            }
            .logo-left img, .logo-right img {
              width: 100%;
              height: 100%;
              object-fit: contain;
            }
            .header-text {
              flex: 1;
              text-align: center;
              padding: 8px 0;
            }
            .society-name-simple {
              font-size: 8px;
              margin-bottom: 1px;
            }
            .institute-name-simple {
              font-weight: bold;
              font-size: 10px;
              text-transform: uppercase;
              margin-bottom: 2px;
            }
            .institute-address-simple {
              font-size: 8px;
            }
            .receipt-type-label {
              font-weight: bold;
              text-align: center;
              text-transform: uppercase;
              font-size: 11px;
              margin-bottom: 10px;
              padding: 6px;
              background: #f0f0f0;
              border: 1px solid #000;
            }
            .info-item {
              display: flex;
              gap: 5px;
              margin-bottom: 4px;
            }
            .label {
              font-weight: bold;
              min-width: 70px;
            }
            .value {
              flex: 1;
            }
            .received-section {
              display: flex;
              justify-content: space-between;
              border: 1px solid #000;
              border-bottom: none;
              padding: 8px 10px;
              background: #f0f0f0;
              font-weight: bold;
              font-size: 10px;
              min-height: 35px;
              align-items: center;
            }
            .fee-details-table {
              border: 1px solid #000;
              margin-bottom: 0;
            }
            .fee-details-table table {
              width: 100%;
              border-collapse: collapse;
            }
            .fee-details-table td {
              padding: 8px 10px;
              border-bottom: 1px solid #ddd;
              font-size: 9px;
              line-height: 1.6;
            }
            .fee-details-table td.fee-name {
              text-transform: uppercase;
            }
            .fee-details-table td.fee-amount {
              text-align: right;
              font-weight: bold;
            }
            .logo-section {
              text-align: center;
              padding: 20px 0;
              border-left: 1px solid #000;
              border-right: 1px solid #000;
              display: flex;
              justify-content: center;
              align-items: center;
              flex-grow: 1;
            }
            .center-logo {
              width: 60px;
              height: 60px;
              opacity: 0.3;
              display: block;
              margin: 0 auto;
            }
            .total-section {
              display: flex;
              justify-content: space-between;
              border: 2px solid #000;
              border-top: 2px solid #000;
              padding: 6px 8px;
              font-weight: bold;
              font-size: 10px;
            }
            .amount-in-words {
              border: 1px solid #000;
              border-top: none;
              padding: 6px 8px;
              font-size: 8px;
            }
            .words-label {
              font-weight: bold;
            }
            .payment-details-footer {
              border: 1px solid #000;
              border-top: none;
              padding: 8px;
              font-size: 7px;
              line-height: 1.6;
            }
            .payment-info {
              margin-bottom: 4px;
            }
            .footer-signature {
              display: flex;
              justify-content: space-between;
              align-items: flex-end;
              border: 1px solid #000;
              border-top: none;
              padding: 10px;
              font-size: 7px;
              min-height: 50px;
            }
            .cashier-info {
              font-size: 7px;
            }
            .cashier-name {
              font-weight: bold;
            }
            .signature-label {
              font-weight: bold;
              text-align: right;
            }
            .page-number {
              text-align: right;
              font-size: 7px;
              margin-top: 6px;
            }
            @media print {
              @page {
                size: A4;
                margin: 10mm;
              }
              body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
              }
              .receipt-container {
                page-break-inside: avoid;
              }
            }
          </style>
        </head>
        <body>
          <div class="receipts-wrapper">
            ${generateReceipt("ORIGINAL")}
            ${generateReceipt("DUPLICATE")}
          </div>
        </body>
        </html>
      `;

      const printWindow = window.open("", "_blank");
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    // Convert number to words function
    const numberToWords = (num) => {
      const ones = [
        "",
        "One",
        "Two",
        "Three",
        "Four",
        "Five",
        "Six",
        "Seven",
        "Eight",
        "Nine",
      ];
      const tens = [
        "",
        "",
        "Twenty",
        "Thirty",
        "Forty",
        "Fifty",
        "Sixty",
        "Seventy",
        "Eighty",
        "Ninety",
      ];
      const teens = [
        "Ten",
        "Eleven",
        "Twelve",
        "Thirteen",
        "Fourteen",
        "Fifteen",
        "Sixteen",
        "Seventeen",
        "Eighteen",
        "Nineteen",
      ];

      if (num === 0) return "Zero";
      if (num < 0) return "Negative " + numberToWords(-num);

      let result = "";

      if (num >= 10000000) {
        result += numberToWords(Math.floor(num / 10000000)) + " Crore ";
        num %= 10000000;
      }

      if (num >= 100000) {
        result += numberToWords(Math.floor(num / 100000)) + " Lakh ";
        num %= 100000;
      }

      if (num >= 1000) {
        result += numberToWords(Math.floor(num / 1000)) + " Thousand ";
        num %= 1000;
      }

      if (num >= 100) {
        result += ones[Math.floor(num / 100)] + " Hundred ";
        num %= 100;
      }

      if (num >= 20) {
        result += tens[Math.floor(num / 10)] + " ";
        num %= 10;
      } else if (num >= 10) {
        result += teens[num - 10] + " ";
        num = 0;
      }

      if (num > 0) {
        result += ones[num] + " ";
      }

      return result.trim();
    };

    return (
      <div className="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto border-2 border-gray-200">
          <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg flex justify-between items-center">
            <h2 className="text-2xl font-bold flex items-center">
              <span className="mr-3 text-3xl">ðŸ§¾</span>
              Official Payment Receipt
            </h2>
            <button
              onClick={() => setShowReceipt(false)}
              className="text-white hover:text-gray-200 transition-colors duration-200"
            >
              <span className="text-3xl">Ã—</span>
            </button>
          </div>

          <div className="p-4" id="receipt-content">
            {/* Professional Receipt Preview - Matching Print Version */}
            <div
              className="bg-white"
              dangerouslySetInnerHTML={{
                __html: `
                  <style>
                    @page {
                      size: A4 landscape;
                      margin: 5mm;
                    }
                    * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                    }
                    body { 
                      font-family: 'Times New Roman', serif; 
                      margin: 0; 
                      padding: 15px; 
                      background: #f8f9fa;
                      line-height: 1.5;
                      color: #2d3748;
                      font-size: 12px;
                      font-weight: 400;
                    }
                    .receipts-wrapper {
                      display: flex;
                      justify-content: center;
                      width: 100%;
                      height: 100%;
                    }
                    .receipt-container {
                      width: 90%;
                      max-width: 650px;
                      border: 2px solid #2d3748;
                      background: white;
                      padding: 20px;
                      margin: 20px auto;
                      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                      page-break-inside: avoid;
                      min-height: 745px;
                      height: auto;
                    }
                    .receipt-header-box {
                      border: 2px solid #2d3748;
                      padding: 10px;
                      margin-bottom: 10px;
                      position: relative;
                      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                    }
                    .duplicate-label {
                      position: absolute;
                      top: 5px;
                      right: 10px;
                      font-weight: bold;
                      font-size: 12px;
                      text-transform: uppercase;
                      color: #dc3545;
                      margin-bottom: 15px;
                    }
                    .institute-header-simple {
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      gap: 8px;
                    }
                    .logo-left, .logo-right {
                      width: 40px;
                      height: 40px;
                      flex-shrink: 0;
                    }
                    .logo-left img, .logo-right img {
                      width: 100%;
                      height: 100%;
                      object-fit: contain;
                    }
                    .header-text {
                      flex: 1;
                      text-align: center;
                      padding: 12px 0;
                    }
                    .society-name-simple {
                      font-size: 11px;
                      margin-bottom: 2px;
                      color: #6c757d;
                    }
                    .institute-name-simple {
                      font-weight: bold;
                      font-size: 14px;
                      text-transform: uppercase;
                      margin-bottom: 4px;
                      color: #1a202c;
                      letter-spacing: 0.5px;
                    }
                    .institute-address-simple {
                      font-size: 11px;
                      color: #6c757d;
                    }
                    .receipt-type-label {
                      font-weight: bold;
                      text-align: center;
                      text-transform: uppercase;
                      font-size: 11px;
                      margin-bottom: 8px;
                      padding: 3px 8px;
                      border: 2px solid #000;
                      border-bottom: 1px solid #000;
                      color: #000;
                      background: white;
                    }
                    .receipt-info-table {
                      width: 100%;
                      border: 2px solid #000;
                      border-collapse: collapse;
                      margin-bottom: 10px;
                      font-size: 10px;
                      background: white;
                    }
                    .receipt-info-table td {
                      border: 1px solid #000;
                      padding: 4px 8px;
                      vertical-align: top;
                    }
                    .receipt-info-table .label-cell {
                      font-weight: bold;
                      width: 20%;
                      color: #000;
                    }
                    .receipt-info-table .value-cell {
                      width: 30%;
                      color: #000;
                    }
                    .received-section {
                      display: flex;
                      justify-content: space-between;
                      border: 2px solid #2d3748;
                      border-bottom: none;
                      padding: 4px 8px;
                      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
                      font-weight: bold;
                      font-size: 11px;
                      color: #1a202c;
                    }
                    .fee-details-table {
                      border: 2px solid #000;
                      margin-bottom: 0;
                    }
                    .fee-details-table table {
                      width: 100%;
                      border-collapse: collapse;
                    }
                    .fee-details-table td {
                      padding: 6px 10px;
                      border-bottom: 1px solid #dee2e6;
                      font-size: 11px;
                    }
                    .fee-details-table td.fee-name {
                      text-transform: uppercase;
                      font-weight: bold;
                      color: #000;
                    }
                    .fee-details-table td.fee-amount {
                      text-align: right;
                      font-weight: bold;
                      color: #000;
                    }
                    .logo-section {
                      text-align: center;
                      padding: 12px 0;
                      border-left: 2px solid #000;
                      border-right: 2px solid #000;
                      background: #f8f9fa;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                    }
                    .center-logo {
                      width: 70px;
                      height: 70px;
                      opacity: 0.4;
                      display: block;
                      margin: 0 auto;
                    }
                    .total-section {
                      display: flex;
                      justify-content: space-between;
                      border: 2px solid #2d3748;
                      border-top: 3px solid #1a202c;
                      padding: 4px 8px;
                      font-weight: bold;
                      font-size: 12px;
                      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                      color: #1a202c;
                    }
                    .amount-in-words {
                      border: 2px solid #000;
                      border-top: none;
                      padding: 5px 8px;
                      font-size: 10px;
                      background: #f8f9fa;
                      color: #000;
                    }
                    .words-label {
                      font-weight: bold;
                    }
                    .payment-details-footer {
                      border: 2px solid #2d3748;
                      border-top: none;
                      padding: 10px;
                      font-size: 10px;
                      line-height: 1.5;
                      background: #f7fafc;
                      color: #2d3748;
                    }
                    .payment-info {
                      margin-bottom: 3px;
                    }
                    .footer-signature {
                      display: flex;
                      justify-content: space-between;
                      align-items: flex-end;
                      border: 2px solid #2d3748;
                      border-top: none;
                      padding: 10px;
                      font-size: 10px;
                      min-height: 40px;
                      background: #f7fafc;
                      color: #2d3748;
                    }
                    .cashier-info {
                      font-size: 9px;
                    }
                    .cashier-name {
                      font-weight: bold;
                    }
                    .signature-label {
                      font-weight: bold;
                      text-align: right;
                    }
                    .page-number {
                      text-align: right;
                      font-size: 9px;
                      margin-top: 5px;
                      color: #6c757d;
                    }
                    @media print {
                      @page {
                        size: A4;
                        margin: 10mm;
                      }
                      body {
                        print-color-adjust: exact;
                        -webkit-print-color-adjust: exact;
                      }
                      .receipt-container {
                        page-break-inside: avoid;
                      }
                    }
                  </style>
                  <div class="receipts-wrapper">
                    ${(() => {
                      const generateReceipt = (label) => `
                        <div class="receipt-container">
                          <div class="receipt-header-box">
                            <div class="duplicate-label">${label}</div>
                            <div class="institute-header-simple">
                              <div class="logo-left">
                                <img src="/logo1.png" alt="Logo" />
                              </div>
                              <div class="header-text">
                                <div class="society-name-simple">Maitrey Educational Society's</div>
                                <div class="institute-name-simple">NAGARJUNA INSTITUTE OF ENGINEERING, TECHNOLOGY & MANAGEMENT</div>
                                <div class="institute-address-simple">Village Satnavri, Amravati Road, Nagpur - 440023</div>
                              </div>
                              <div class="logo-right">
                                <img src="/logo.png" alt="Logo" />
                              </div>
                            </div>
                          </div>
                          
                          <div class="receipt-type-label">EXAM (OTHER FEES RECEIPT)</div>

                          <table class="receipt-info-table">
                            <tr>
                              <td class="label-cell">Rec. No.</td>
                              <td class="value-cell">: ${receiptData.receiptNumber}</td>
                              <td class="label-cell">Date</td>
                              <td class="value-cell">: ${receiptData.date}</td>
                            </tr>
                            <tr>
                              <td class="label-cell">Class</td>
                              <td class="value-cell">: ${receiptData.student?.program || 'N/A'}</td>
                              <td class="label-cell">Adm. No.</td>
                              <td class="value-cell">: ${receiptData.student?.admissionNumber || receiptData.student?.studentId}</td>
                            </tr>
                            <tr>
                              <td class="label-cell">Category</td>
                              <td class="value-cell">: ${receiptData.student?.caste || receiptData.student?.casteCategory || 'N/A'}</td>
                              <td class="label-cell">Student Id.</td>
                              <td class="value-cell">: ${receiptData.student?.studentId}</td>
                            </tr>
                            <tr>
                              <td class="label-cell">Name</td>
                              <td class="value-cell" colspan="3">: ${receiptData.student?.firstName} ${receiptData.student?.lastName}</td>
                            </tr>
                            <tr>
                              <td class="label-cell">Roll No</td>
                              <td class="value-cell">: ${receiptData.student?.rollNumber || 'N/A'}</td>
                              <td class="label-cell">Section</td>
                              <td class="value-cell">: ${receiptData.student?.section || 'N/A'}</td>
                            </tr>
                          </table>
                          
                          <div class="received-section">
                            <div class="received-label">Received the following:</div>
                            <div class="amount-label">(â‚¹)Amount</div>
                          </div>
                          
                          <div class="fee-details-table">
                            <table>
                              <tbody>
                                ${
                                  receiptData.multipleFees && receiptData.multipleFees.length > 0
                                    ? receiptData.multipleFees
                                        .map(
                                          (fee, index) => `
                                <tr>
                                  <td class="fee-name">${fee.feeHead}</td>
                                  <td class="fee-amount">${fee.currentPayment.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                              `
                                        )
                                        .join("")
                                    : `
                                <tr>
                                  <td class="fee-name">${receiptData.feeHead?.title || receiptData.description || 'Fee Payment'}</td>
                                  <td class="fee-amount">${parseInt(receiptData.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                              `
                                }
                              </tbody>
                            </table>
                                                   </div>
                          
                          <div class="logo-section">
                            <img src="/logo.png" alt="NIETM Logo" class="center-logo" />
                          </div>
                          
                          <div class="total-section">
                            <div class="total-label">Total :</div>
                            <div class="total-amount">â‚¹ ${parseInt(receiptData.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                          </div>
                          
                          <div class="amount-in-words">
                            <span class="words-label">In words:</span> ${numberToWords(parseInt(receiptData.amount))} Only
                          </div>
                          
                          <div class="payment-details-footer">
                            <div class="payment-info">Med : ${receiptData.description || 'N/A'}</div>
                            ${receiptData.paymentMethod === 'UPI' || receiptData.paymentMethod === 'Online' ? `
                            <div class="payment-info">UPI Amount : ${parseInt(receiptData.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bank Info = Transaction ID : ${receiptData.transactionId || 'N/A'}, Date : ${receiptData.date}</div>
                            <div class="payment-info">Bank Name : ${receiptData.bankName || 'N/A'}, Location : ${receiptData.bankLocation || 'N/A'}</div>
                            ` : ''}
                            <div class="payment-info">Remarks : ${receiptData.remarks || receiptData.description || 'Payment Received'}</div>
                          </div>
                          
                          <div class="footer-signature">
                            <div class="cashier-info">O1-${receiptData.collectedBy || 'Cashier'}/${receiptData.date}</div>
                            <div class="cashier-name">${receiptData.collectedBy || 'Cashier Name'}</div>
                            <div class="signature-label">RECEIVER'S SIGNATURE</div>
                          </div>
                          
                          <div class="page-number">Page 1 of 1</div>
                        </div>
                      `;
                      return generateReceipt("ORIGINAL");
                    })()}
                  </div>
                `,
              }}
            />
          </div>

          {/* Modal Actions */}
          <div className=" gap-3 border-t border-gray-200 pt-20 pb-6 px-6 flex justify-end space-x-8 bg-gradient-to-r from-gray-50 to-gray-100">
            <button
              onClick={printReceipt}
              className="w-32 px-10 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 flex items-center justify-center font-semibold shadow-lg transition-all duration-300 transform hover:scale-105 text-sm"
            >
              <span className="mr-2 text-2xl">ðŸ–¨ï¸</span>
              Print Receipt
            </button>
            <button
              onClick={() => setShowReceipt(false)}
              className="w-30 px-8 py-2 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-lg hover:from-gray-700 hover:to-gray-800 flex items-center justify-center font-semibold shadow-lg transition-all duration-300 transform hover:scale-105 text-lg"
            >
              <span className="mr-2 text-2xl">âœ•</span>
              Close
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <>
      <ReceiptModal />
      <div className="min-h-screen bg-gray-50 p-6">
        <div className="max-w-4xl mx-auto">
          {/* Professional Header */}
          <div className="mb-8 bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-8 text-white shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-5xl font-bold mb-4 flex items-center gradient-text">
                  <span className="bg-white text-blue-600 rounded-xl p-4 mr-5 shadow-primary">
                    ðŸ’³
                  </span>
                  Professional Fee Management
                </h1>
                <p className="text-blue-100 text-xl font-medium">
                  Advanced payment processing with intelligent receipt
                  generation
                </p>
                <div className="flex items-center mt-4 text-blue-200">
                  <div className="bg-white bg-opacity-20 rounded-lg px-3 py-1 mr-4 flex items-center">
                    <span className="mr-2">ðŸ“…</span>
                    <span>Academic Year: {formData.academicYear}</span>
                  </div>
                  <div className="bg-white bg-opacity-20 rounded-lg px-3 py-1 mr-4 flex items-center">
                    <span className="mr-2">ðŸ‘¥</span>
                    <span>
                      {loadingStudents ? "Loading..." : `${students.length} Students`}
                    </span>
                  </div>
                  <div className="bg-white bg-opacity-20 rounded-lg px-3 py-1 flex items-center">
                    <span className="mr-2">ðŸ’°</span>
                    <span>{feeHeads.length} Fee Categories</span>
                  </div>
                </div>
              </div>
              <div className="hidden md:flex flex-col items-center">
                <div className="bg-white bg-opacity-20 rounded-2xl p-8 mb-3 animate-pulse">
                  <span className="text-7xl">ðŸ«</span>
                </div>
                <span className="text-base font-semibold text-blue-200">
                  NIETM Payment Portal
                </span>
                <span className="text-sm text-blue-300">
                  Secure â€¢ Fast â€¢ Reliable
                </span>
              </div>
            </div>
          </div>

          {/* Enhanced Success/Error Messages with Animation */}
          {success && (
            <div className="mb-8 p-6 message-success rounded-xl shadow-success animate-fadeIn">
              <div className="flex items-start">
                <div className="flex-shrink-0">
                  <div className="w-10 h-10 gradient-success rounded-full flex items-center justify-center animate-bounce">
                    <span className="text-white text-xl font-bold">âœ“</span>
                  </div>
                </div>
                <div className="ml-4 flex-1">
                  <h3 className="text-xl font-bold text-green-800 mb-2 flex items-center gap-2">
                    <span>ðŸŽ‰</span>
                    Payment Successful!
                  </h3>
                  <p className="text-green-700 text-lg font-medium">
                    {success}
                  </p>
                  <div className="mt-4 grid grid-cols-3 gap-4 text-sm text-green-600">
                    <div className="flex items-center gap-1">
                      <span className="animate-pulse">ðŸ§¾</span>
                      <span>Receipt Generated</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <span className="animate-pulse">ðŸ’¾</span>
                      <span>Data Saved</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <span className="animate-pulse">ðŸ“§</span>
                      <span>Notification Sent</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {error && (
            <div className="mb-8 p-6 message-error rounded-xl shadow-warning animate-fadeIn">
              <div className="flex items-start">
                <div className="flex-shrink-0">
                  <div className="w-10 h-10 gradient-warning rounded-full flex items-center justify-center">
                    <span className="text-white text-xl font-bold">âš </span>
                  </div>
                </div>
                <div className="ml-4 flex-1">
                  <h3 className="text-xl font-bold text-red-800 mb-2 flex items-center gap-2">
                    <span>ðŸš¨</span>
                    Payment Error
                  </h3>
                  <p className="text-red-700 text-lg font-medium">{error}</p>
                  <div className="mt-4 flex justify-between items-center">
                    <div className="text-sm text-red-600">
                      <span className="mr-4">
                        ðŸ” Check details and try again
                      </span>
                      <span>ðŸ“ž Contact support if issue persists</span>
                    </div>
                    <button
                      onClick={() => setError("")}
                      className="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 font-medium rounded-lg transition-colors duration-200"
                    >
                      âœ• Dismiss
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Payment Form */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Payment Type Selection */}
              <div className="border-b border-gray-200 pb-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                  <span className="text-xl mr-2">ðŸ’³</span>
                  Payment Type
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="specific"
                      checked={formData.paymentType === "specific"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "specific"
                          ? "border-blue-500 bg-blue-50 text-blue-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸŽ¯</div>
                      <div className="font-medium">Specific Fee</div>
                      <div className="text-sm text-gray-500">
                        Pay for specific fee head
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="multiple"
                      checked={formData.paymentType === "multiple"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "multiple"
                          ? "border-green-500 bg-green-50 text-green-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸ“Š</div>
                      <div className="font-medium">Multiple Fees</div>
                      <div className="text-sm text-gray-500">
                        Pay for multiple fee heads
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="annual"
                      checked={formData.paymentType === "annual"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "annual"
                          ? "border-orange-500 bg-orange-50 text-orange-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸ“…</div>
                      <div className="font-medium">Annual Fees</div>
                      <div className="text-sm text-gray-500">
                        Pay yearly fees
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="transport"
                      checked={formData.paymentType === "transport"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "transport"
                          ? "border-yellow-500 bg-yellow-50 text-yellow-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸšŒ</div>
                      <div className="font-medium">Transport Fees</div>
                      <div className="text-sm text-gray-500">
                        Bus/transport fees
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="hostel"
                      checked={formData.paymentType === "hostel"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "hostel"
                          ? "border-indigo-500 bg-indigo-50 text-indigo-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸ </div>
                      <div className="font-medium">Hostel Fees</div>
                      <div className="text-sm text-gray-500">
                        Accommodation fees
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="library"
                      checked={formData.paymentType === "library"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "library"
                          ? "border-teal-500 bg-teal-50 text-teal-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸ“–</div>
                      <div className="font-medium">Library Fees</div>
                      <div className="text-sm text-gray-500">
                        Library services
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="lab"
                      checked={formData.paymentType === "lab"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "lab"
                          ? "border-pink-500 bg-pink-50 text-pink-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸ”¬</div>
                      <div className="font-medium">Lab Fees</div>
                      <div className="text-sm text-gray-500">
                        Laboratory usage
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="sports"
                      checked={formData.paymentType === "sports"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "sports"
                          ? "border-emerald-500 bg-emerald-50 text-emerald-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">âš½</div>
                      <div className="font-medium">Sports Fees</div>
                      <div className="text-sm text-gray-500">
                        Sports facilities
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="admission"
                      checked={formData.paymentType === "admission"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "admission"
                          ? "border-purple-500 bg-purple-50 text-purple-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸŽ“</div>
                      <div className="font-medium">Admission Fees</div>
                      <div className="text-sm text-gray-500">
                        One-time admission charges
                      </div>
                    </div>
                  </label>

                  <label className="relative">
                    <input
                      type="radio"
                      name="paymentType"
                      value="exam"
                      checked={formData.paymentType === "exam"}
                      onChange={handleInputChange}
                      className="sr-only"
                    />
                    <div
                      className={`p-4 border-2 rounded-lg cursor-pointer text-center transition ${
                        formData.paymentType === "exam"
                          ? "border-red-500 bg-red-50 text-red-700"
                          : "border-gray-300 hover:border-gray-400"
                      }`}
                    >
                      <div className="text-2xl mb-2">ðŸ“</div>
                      <div className="font-medium">Exam Fees</div>
                      <div className="text-sm text-gray-500">
                        Examination charges
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              {/* Academic Year Selection */}
              <div className="border-b border-gray-200 pb-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                  <span className="text-xl mr-2">ðŸ“…</span>
                  Academic Year
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                  {academicYears.map((year) => (
                    <label key={year.value} className="relative">
                      <input
                        type="radio"
                        name="academicYear"
                        value={year.value}
                        checked={formData.academicYear === year.value}
                        onChange={handleInputChange}
                        className="sr-only"
                      />
                      <div
                        className={`p-3 border-2 rounded-lg cursor-pointer text-center transition ${
                          formData.academicYear === year.value
                            ? "border-orange-500 bg-orange-50 text-orange-700"
                            : "border-gray-300 hover:border-gray-400"
                        } ${year.isCurrent ? "ring-2 ring-orange-200" : ""}`}
                      >
                        <div className="font-medium">{year.label}</div>
                        {year.isCurrent && (
                          <div className="text-xs text-orange-600">Current</div>
                        )}
                      </div>
                    </label>
                  ))}
                </div>
              </div>

              {/* Student Selection - Only for Student Payments */}
              {(formData.paymentType === "specific" ||
                formData.paymentType === "multiple" ||
                formData.paymentType === "annual" ||
                formData.paymentType === "admission" ||
                formData.paymentType === "exam" ||
                formData.paymentType === "transport" ||
                formData.paymentType === "hostel" ||
                formData.paymentType === "library" ||
                formData.paymentType === "lab" ||
                formData.paymentType === "sports" ||
                formData.paymentType === "development" ||
                formData.paymentType === "miscellaneous") && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ‘¤</span>
                    Student Information
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="relative">
                      <label className="text-sm font-bold text-gray-800 mb-3 flex items-center">
                        <span className="mr-2">ðŸ‘¤</span>
                        Select Student *
                        <button
                          type="button"
                          onClick={fetchStudents}
                          disabled={loadingStudents}
                          className="ml-2 text-blue-600 hover:text-blue-800 disabled:text-gray-400 transition-colors duration-200"
                          title="Refresh student list"
                        >
                          {loadingStudents ? "âŸ³" : "ðŸ”„"}
                        </button>
                      </label>

                      {/* Enhanced Professional Searchable Select */}
                      <div className="relative">
                        <div
                          className={`w-full pl-12 pr-12 py-4 border-2 rounded-xl text-lg font-medium transition-all duration-300 bg-white shadow-sm hover:shadow-lg cursor-pointer ${
                            isDropdownOpen
                              ? "border-blue-500 ring-4 ring-blue-500/10 shadow-xl"
                              : "border-gray-300 hover:border-blue-400 focus-within:ring-4 focus-within:ring-blue-500/20 focus-within:border-blue-500"
                          }`}
                          onClick={() => {
                            if (!loadingStudents) {
                              setIsDropdownOpen(!isDropdownOpen);
                              if (!isDropdownOpen) {
                                setHighlightedIndex(-1);
                              }
                            }
                          }}
                          tabIndex={0}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                              e.preventDefault();
                              !loadingStudents && setIsDropdownOpen(!isDropdownOpen);
                            } else if (e.key === 'Escape') {
                              setIsDropdownOpen(false);
                              setHighlightedIndex(-1);
                            } else if (isDropdownOpen) {
                              if (e.key === 'ArrowDown') {
                                e.preventDefault();
                                setHighlightedIndex(prev =>
                                  prev < filteredStudents.length - 1 ? prev + 1 : 0
                                );
                              } else if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                setHighlightedIndex(prev =>
                                  prev > 0 ? prev - 1 : filteredStudents.length - 1
                                );
                              } else if (e.key === 'Enter' && highlightedIndex >= 0) {
                                e.preventDefault();
                                handleStudentSelect(filteredStudents[highlightedIndex]);
                              }
                            }
                          }}
                        >
                          <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">
                            <span className="text-xl">ðŸŽ“</span>
                          </div>

                          <div className="flex items-center justify-between">
                            <span className={`truncate ${selectedStudent ? "text-gray-900" : "text-gray-500"}`}>
                              {selectedStudent
                                ? `${selectedStudent.firstName} ${selectedStudent.lastName} - ${selectedStudent.studentId}`
                                : (loadingStudents
                                  ? "Loading students..."
                                  : "-- Select Student --"
                                )
                              }
                            </span>
                            <div className="flex items-center space-x-2 ml-4">
                              {selectedStudent && (
                                <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                  {selectedStudent.firstName?.charAt(0)}{selectedStudent.lastName?.charAt(0)}
                                </div>
                              )}
                              <div className={`text-gray-400 transition-transform duration-200 ${isDropdownOpen ? 'rotate-180' : ''}`}>
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Enhanced Dropdown */}
                        {isDropdownOpen && !loadingStudents && (
                          <div className="absolute z-50 w-full mt-3 bg-white border-2 border-gray-200 rounded-xl shadow-2xl max-h-96 overflow-hidden animate-fadeIn">
                            {/* Enhanced Search Input */}
                            <div className="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                              <div className="relative">
                                <input
                                  type="text"
                                  placeholder="ðŸ” Search by name, ID, department, or semester..."
                                  value={studentSearchTerm}
                                  onChange={(e) => {
                                    setStudentSearchTerm(e.target.value);
                                    handleStudentSearch(e.target.value);
                                    e.stopPropagation();
                                  }}
                                  onClick={(e) => e.stopPropagation()}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Escape') {
                                      setIsDropdownOpen(false);
                                    }
                                  }}
                                  className="w-full pl-10 pr-12 py-3 border-2 border-blue-200 rounded-lg focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 text-base transition-all duration-200 bg-white shadow-sm"
                                  autoFocus
                                />
                                <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                  </svg>
                                </div>
                                {studentSearchTerm && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      setStudentSearchTerm("");
                                      setHighlightedIndex(-1);
                                      e.stopPropagation();
                                    }}
                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                                    title="Clear search"
                                  >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                  </button>
                                )}
                              </div>
                            </div>

                            {/* Enhanced Options List */}
                            <div className="max-h-72 overflow-y-auto">
                              {filteredStudents.length > 0 ? (
                                filteredStudents.map((student, index) => (
                                  <div
                                    key={student._id}
                                    className={`px-4 py-4 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-all duration-200 ${
                                      formData.studentId === student._id
                                        ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500'
                                        : highlightedIndex === index
                                        ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500'
                                        : ''
                                    }`}
                                    onClick={() => handleStudentSelect(student)}
                                    onMouseEnter={() => setHighlightedIndex(index)}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Enter' || e.key === ' ') {
                                        e.preventDefault();
                                        handleStudentSelect(student);
                                      }
                                    }}
                                    tabIndex={0}
                                  >
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center space-x-4 flex-1">
                                        {/* Student Avatar */}
                                        <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md">
                                          {student.firstName?.charAt(0)}{student.lastName?.charAt(0)}
                                        </div>

                                        {/* Student Details */}
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center space-x-2 mb-1">
                                            <div className="font-semibold text-gray-900 truncate">
                                              {student.firstName} {student.lastName}
                                            </div>
                                            {formData.studentId === student._id && (
                                              <div className="flex items-center text-green-600">
                                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                </svg>
                                              </div>
                                            )}
                                          </div>

                                          <div className="flex items-center space-x-4 text-sm text-gray-600">
                                            <div className="flex items-center space-x-1">
                                              <svg className="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                              </svg>
                                              <span className="font-medium">{student.studentId}</span>
                                            </div>

                                            {student.currentSemester && (
                                              <div className="flex items-center space-x-1">
                                                <svg className="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                                </svg>
                                                <span>Sem {student.currentSemester}</span>
                                              </div>
                                            )}

                                            <div className="flex items-center space-x-1">
                                              <svg className="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                              </svg>
                                              <span className="truncate">
                                                {typeof student.department === "object"
                                                  ? student.department?.name || "N/A"
                                                  : student.department || "N/A"
                                                }
                                              </span>
                                            </div>
                                          </div>

                                          {/* Caste Badge */}
                                          <div className="mt-2">
                                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                              student.caste === 'General' || student.casteCategory === 'General'
                                                ? 'bg-gray-100 text-gray-800'
                                                : student.caste === 'OBC' || student.casteCategory === 'OBC'
                                                ? 'bg-yellow-100 text-yellow-800'
                                                : student.caste === 'SC' || student.casteCategory === 'SC'
                                                ? 'bg-red-100 text-red-800'
                                                : student.caste === 'ST' || student.casteCategory === 'ST'
                                                ? 'bg-green-100 text-green-800'
                                                : 'bg-blue-100 text-blue-800'
                                            }`}>
                                              {student.caste || student.casteCategory || 'N/A'}
                                            </span>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                ))
                              ) : (
                                <div className="px-6 py-12 text-center text-gray-500">
                                  <div className="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                                    <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                  </div>
                                  <div className="font-medium text-lg mb-2">
                                    {studentSearchTerm
                                      ? "No students found"
                                      : "No students available"
                                    }
                                  </div>
                                  <div className="text-sm text-gray-400 mb-4">
                                    {studentSearchTerm
                                      ? "Try adjusting your search terms"
                                      : "Please refresh or check your connection"
                                    }
                                  </div>
                                  {studentSearchTerm && (
                                    <button
                                      type="button"
                                      onClick={() => {
                                        setStudentSearchTerm("");
                                        setHighlightedIndex(-1);
                                      }}
                                      className="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors duration-200"
                                    >
                                      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                      </svg>
                                      Clear search
                                    </button>
                                  )}
                                </div>
                              )}
                            </div>

                            {/* Enhanced Footer */}
                            <div className="px-4 py-3 bg-gradient-to-r from-gray-50 to-blue-50 border-t border-gray-200">
                              <div className="flex items-center justify-between text-sm text-gray-600">
                                <div className="flex items-center space-x-4">
                                  <span className="flex items-center space-x-1">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    <span>{filteredStudents.length} student{filteredStudents.length === 1 ? '' : 's'}</span>
                                  </span>
                                  {studentSearchTerm && (
                                    <span className="text-blue-600 font-medium">
                                      Filtered results
                                    </span>
                                  )}
                                </div>
                                <div className="text-xs text-gray-500">
                                  Use â†‘â†“ to navigate, Enter to select
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Click outside to close */}
                      {isDropdownOpen && (
                        <div
                          className="fixed inset-0 z-40"
                          onClick={() => {
                            setIsDropdownOpen(false);
                            setHighlightedIndex(-1);
                          }}
                        />
                      )}
                    </div>

                    <div className="mt-4">
                      <label className="flex items-center space-x-3">
                        <input
                          type="checkbox"
                          name="tfws"
                          checked={formData.tfws || false}
                          onChange={(e) => {
                            const checked = e.target.checked;
                            setFormData((prev) => ({
                              ...prev,
                              tfws: checked,
                            }));
                            // Clear payment-related fields if condition is met
                            if (checked && FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste)) {
                              setFormData((prev) => ({
                                ...prev,
                                amount: "0", // Set amount to 0 for reserved + TFWS students
                                // Keep payment method but clear UTR and collected by for reserved + TFWS
                                utr: "",
                                collectedBy: "",
                                remarks: ""
                              }));
                            }
                          }}
                          className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                        />
                        <span className="text-sm font-medium text-gray-800">
                          <span className="mr-2">ðŸŽ“</span>
                          Tuition Fee Waiver Scheme (TFWS)
                        </span>
                      </label>
                      <p className="text-xs text-gray-600 mt-1 ml-7">
                        Check this if the student is eligible for TFWS (Tuition Fee Waiver Scheme)
                      </p>
                    </div>

                    {/* Fee Calculation Display */}
                    {selectedStudent && calculatedFee.category && (
                      <div className="mt-4 bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl p-4 shadow-md">
                        <h4 className="text-lg font-bold text-green-800 mb-3 flex items-center">
                          <span className="mr-2">ðŸ’°</span>
                          Fee Calculation
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="bg-white p-3 rounded-lg border border-green-300">
                            <div className="text-sm text-gray-600">Category</div>
                            <div className="font-bold text-green-700">
                              {calculatedFee.category}
                            </div>
                          </div>
                          <div className="bg-white p-3 rounded-lg border border-green-300">
                            <div className="text-sm text-gray-600">Fee Percentage</div>
                            <div className="font-bold text-blue-700">
                              {calculatedFee.percentage}%
                            </div>
                          </div>
                          <div className="bg-white p-3 rounded-lg border border-green-300">
                            <div className="text-sm text-gray-600">Calculated Amount</div>
                            <div className="font-bold text-purple-700">
                              â‚¹{calculatedFee.finalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </div>
                          </div>
                        </div>
                        {calculatedFee.percentage === 0 && (
                          <div className="mt-3 bg-green-100 border border-green-300 rounded-lg p-3">
                            <div className="flex items-center text-green-800">
                              <span className="mr-2">âœ…</span>
                              <span className="font-medium">
                                Zero fees applicable for this student category
                              </span>
                            </div>
                          </div>
                        )}
                        {FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && (
                          <div className="mt-3 bg-blue-100 border border-blue-300 rounded-lg p-3">
                            <div className="flex items-center text-blue-800">
                              <span className="mr-2">ðŸŽ“</span>
                              <span className="font-medium">
                                TFWS applied to reserved category - Payment fields disabled
                              </span>
                            </div>
                          </div>
                        )}
                        {calculatedFee.percentage === 50 && (
                          <div className="mt-3 bg-yellow-100 border border-yellow-300 rounded-lg p-3">
                            <div className="flex items-center text-yellow-800">
                              <span className="mr-2">ðŸ’°</span>
                              <span className="font-medium">50% fee concession applicable</span>
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    {selectedStudent && (
                      <div className="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-6 rounded-2xl border-2 border-blue-200 shadow-xl animate-fadeIn relative overflow-hidden">
                        {/* Background Pattern */}
                        <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-200/20 to-purple-200/20 rounded-full -translate-y-16 translate-x-16"></div>
                        <div className="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-indigo-200/20 to-blue-200/20 rounded-full translate-y-12 -translate-x-12"></div>

                        <div className="relative z-10">
                          <h4 className="font-bold text-blue-900 mb-6 text-xl flex items-center">
                            <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white mr-3 shadow-lg">
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                              </svg>
                            </div>
                            Student Profile
                          </h4>

                          {/* Student Header Card */}
                          <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 mb-4 shadow-lg border border-white/50">
                            <div className="flex items-center space-x-4">
                              <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">
                                {selectedStudent.firstName?.charAt(0)}{selectedStudent.lastName?.charAt(0)}
                              </div>
                              <div className="flex-1">
                                <h5 className="font-bold text-gray-900 text-lg">
                                  {selectedStudent.firstName} {selectedStudent.lastName}
                                </h5>
                                <p className="text-blue-600 font-medium">{selectedStudent.studentId}</p>
                                <div className="flex items-center space-x-2 mt-1">
                                  <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                    selectedStudent.caste === 'General' || selectedStudent.casteCategory === 'General'
                                      ? 'bg-gray-100 text-gray-800'
                                      : selectedStudent.caste === 'OBC' || selectedStudent.casteCategory === 'OBC'
                                      ? 'bg-yellow-100 text-yellow-800'
                                      : selectedStudent.caste === 'SC' || selectedStudent.casteCategory === 'SC'
                                      ? 'bg-red-100 text-red-800'
                                      : selectedStudent.caste === 'ST' || selectedStudent.casteCategory === 'ST'
                                      ? 'bg-green-100 text-green-800'
                                      : 'bg-blue-100 text-blue-800'
                                  }`}>
                                    {selectedStudent.caste || selectedStudent.casteCategory || 'N/A'}
                                  </span>
                                  {selectedStudent.currentSemester && (
                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                      Semester {selectedStudent.currentSemester}
                                    </span>
                                  )}
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Student Details Grid */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-white/50 hover:shadow-xl transition-shadow duration-200">
                              <div className="flex items-center space-x-3 mb-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                  </svg>
                                </div>
                                <span className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Department</span>
                              </div>
                              <p className="text-blue-800 font-bold text-base ml-11">
                                {typeof selectedStudent.department === "object"
                                  ? selectedStudent.department?.name || "N/A"
                                  : selectedStudent.department || "N/A"}
                              </p>
                            </div>

                            <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-white/50 hover:shadow-xl transition-shadow duration-200">
                              <div className="flex items-center space-x-3 mb-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                  </svg>
                                </div>
                                <span className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Program</span>
                              </div>
                              <p className="text-green-800 font-bold text-base ml-11">
                                {typeof selectedStudent.program === "object"
                                  ? selectedStudent.program?.name || "N/A"
                                  : selectedStudent.program || "N/A"}
                              </p>
                            </div>

                            <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-white/50 hover:shadow-xl transition-shadow duration-200">
                              <div className="flex items-center space-x-3 mb-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                  </svg>
                                </div>
                                <span className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Semester</span>
                              </div>
                              <p className="text-purple-800 font-bold text-base ml-11">
                                {selectedStudent.currentSemester || 'N/A'}
                              </p>
                            </div>

                            <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-white/50 hover:shadow-xl transition-shadow duration-200">
                              <div className="flex items-center space-x-3 mb-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg flex items-center justify-center">
                                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                  </svg>
                                </div>
                                <span className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Gender</span>
                              </div>
                              <p className="text-pink-800 font-bold text-base ml-11">
                                {getStudentGender(selectedStudent)
                                  ? getStudentGender(selectedStudent).charAt(0).toUpperCase() + getStudentGender(selectedStudent).slice(1)
                                  : (selectedStudent?.gender || selectedStudent?.sex || 'N/A')}
                              </p>
                            </div>
                          </div>

                          {/* Contact Information */}
                          {selectedStudent.email && (
                            <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 mt-4 shadow-lg border border-white/50">
                              <div className="flex items-center space-x-3 mb-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center">
                                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                  </svg>
                                </div>
                                <span className="font-semibold text-gray-700 text-sm uppercase tracking-wide">Email</span>
                              </div>
                              <p className="text-red-800 font-bold text-base ml-11 break-all">
                                {selectedStudent.email}
                              </p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Pending Fees Section - Only for Specific Payment */}
                  {selectedStudent &&
                    formData.paymentType === "specific" &&
                    pendingFees.length > 0 && (
                      <div className="mt-6">
                        <h4 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                          <span className="text-xl mr-2">â°</span>
                          Pending Fees
                        </h4>
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {pendingFees.map((fee, index) => (
                              <div
                                key={index}
                                className="bg-white p-3 rounded-lg border border-yellow-300"
                              >
                                <div className="text-sm">
                                  <p className="font-medium text-gray-900">
                                    {fee.feeHead}
                                  </p>
                                  <p className="text-red-600 font-semibold">
                                    Pending: â‚¹{fee.pendingAmount}
                                  </p>
                                  <p className="text-gray-600">
                                    Total: â‚¹{fee.totalAmount}
                                  </p>
                                  {fee.paidAmount > 0 && (
                                    <p className="text-green-600">
                                      Paid: â‚¹{fee.paidAmount}
                                    </p>
                                  )}
                                  {fee.dueDate && (
                                    <p className="text-orange-600 text-xs">
                                      Due:{" "}
                                      {new Date(
                                        fee.dueDate
                                      ).toLocaleDateString()}
                                    </p>
                                  )}
                                </div>
                                <button
                                  type="button"
                                  onClick={() => {
                                    setFormData((prev) => ({
                                      ...prev,
                                      feeHead: fee.feeHeadId,
                                      amount: fee.pendingAmount.toString(),
                                      manualFeeHeadName: fee.feeHead,
                                      manualFeeAmount: fee.pendingAmount.toString(),
                                      feeName: fee.feeHead,
                                      paymentType: "specific",
                                    }));
                                  }}
                                  className="mt-2 text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition"
                                >
                                  Quick Fill
                                </button>
                              </div>
                            ))}
                          </div>
                          <div className="mt-3 text-sm text-yellow-700 bg-yellow-100 p-2 rounded">
                            <span className="font-medium">ðŸ’¡ Tip:</span> Click
                            "Quick Fill" to automatically set the fee head and
                            pending amount in the payment form.
                          </div>
                        </div>
                      </div>
                    )}

                  {/* Multiple Fee Heads Selection - Only for Multiple Payment */}
                  {selectedStudent && formData.paymentType === "multiple" && (
                    <div className="mt-6">
                      <h4 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span className="text-xl mr-2">ðŸ“Š</span>
                        Select Multiple Fee Heads
                      </h4>
                      <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                        {pendingFees.length > 0 ? (
                          <>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                              {pendingFees.map((fee, index) => (
                                <label key={index} className="relative">
                                  <input
                                    type="checkbox"
                                    checked={formData.selectedFeeHeads.includes(
                                      fee.feeHeadId
                                    )}
                                    onChange={(e) => {
                                      const checked = e.target.checked;
                                      const updatedFeeHeads = checked
                                        ? [
                                            ...formData.selectedFeeHeads,
                                            fee.feeHeadId,
                                          ]
                                        : formData.selectedFeeHeads.filter(
                                            (id) => id !== fee.feeHeadId
                                          );

                                      // Show visual feedback for selection
                                      if (checked) {
                                        setSuccess(
                                          `âœ… Added ${
                                            fee.feeHead
                                          } (â‚¹${fee.pendingAmount.toLocaleString()}) to payment`
                                        );
                                        setTimeout(() => setSuccess(""), 2000);
                                      } else {
                                        setSuccess(
                                          `âŒ Removed ${fee.feeHead} from payment`
                                        );
                                        setTimeout(() => setSuccess(""), 1500);
                                      }

                                      // Auto-calculate total and adjust payment type
                                      const totalAmount =
                                        updatedFeeHeads.reduce((sum, id) => {
                                          const pendingFee = pendingFees.find(
                                            (f) => f.feeHeadId === id
                                          );
                                          return (
                                            sum +
                                            (pendingFee
                                              ? pendingFee.pendingAmount
                                              : 0)
                                          );
                                        }, 0);

                                      setFormData((prev) => ({
                                        ...prev,
                                        selectedFeeHeads: updatedFeeHeads,
                                        amount:
                                          updatedFeeHeads.length > 0
                                            ? totalAmount.toString()
                                            : prev.amount,
                                        feeHead:
                                          updatedFeeHeads.length === 1
                                            ? updatedFeeHeads[0]
                                            : "",
                                      }));
                                    }}
                                    className="sr-only"
                                  />
                                  <div
                                    className={`p-4 border-2 rounded-xl cursor-pointer text-center transition-all duration-300 transform hover:scale-[1.02] ${
                                      formData.selectedFeeHeads.includes(
                                        fee.feeHeadId
                                      )
                                        ? "border-green-500 bg-gradient-to-br from-green-50 to-green-100 shadow-lg shadow-green-200/50"
                                        : "border-gray-300 hover:border-green-400 bg-white hover:shadow-md"
                                    }`}
                                  >
                                    <div className="flex items-start justify-between">
                                      <div className="text-sm flex-1">
                                        <div className="flex items-center gap-2 mb-2">
                                          <p className="font-semibold text-gray-900">
                                            {fee.feeHead}
                                          </p>
                                          {formData.selectedFeeHeads.includes(
                                            fee.feeHeadId
                                          ) && (
                                            <span className="animate-bounce">
                                              <svg
                                                className="w-4 h-4 text-green-600"
                                                fill="currentColor"
                                                viewBox="0 0 20 20"
                                              >
                                                <path
                                                  fillRule="evenodd"
                                                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                  clipRule="evenodd"
                                                />
                                              </svg>
                                            </span>
                                          )}
                                        </div>
                                        <p className="text-red-600 font-bold text-base">
                                          â‚¹{fee.pendingAmount.toLocaleString()}
                                        </p>
                                        <p className="text-gray-600">
                                          Total: â‚¹{fee.totalAmount}
                                        </p>
                                        {fee.paidAmount > 0 && (
                                          <p className="text-green-600">
                                            Paid: â‚¹{fee.paidAmount}
                                          </p>
                                        )}
                                        {fee.dueDate && (
                                          <p className="text-orange-600 text-xs">
                                            Due:{" "}
                                            {new Date(
                                              fee.dueDate
                                            ).toLocaleDateString()}
                                          </p>
                                        )}
                                      </div>
                                      <div
                                        className={`w-5 h-5 rounded border-2 flex items-center justify-center ml-2 ${
                                          formData.selectedFeeHeads.includes(
                                            fee.feeHeadId
                                          )
                                            ? "border-green-500 bg-green-500"
                                            : "border-gray-300"
                                        }`}
                                      >
                                        {formData.selectedFeeHeads.includes(
                                          fee.feeHeadId
                                        ) && (
                                          <span className="text-white text-xs">
                                            âœ“
                                          </span>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                </label>
                              ))}
                            </div>

                            {/* Enhanced Multiple Fee Summary with Animation */}
                            {formData.selectedFeeHeads.length > 0 && (
                              <div className="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-xl p-6 animate-fadeIn shadow-lg">
                                <div className="flex justify-between items-center mb-4">
                                  <h5 className="font-bold text-green-900 text-lg flex items-center gap-2">
                                    <span className="animate-pulse">ðŸ’°</span>
                                    Payment Summary
                                  </h5>
                                  <span className="bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                    {formData.selectedFeeHeads.length} fee head
                                    {formData.selectedFeeHeads.length > 1
                                      ? "s"
                                      : ""}{" "}
                                    selected
                                  </span>
                                </div>
                                <div className="space-y-3 mb-4">
                                  {formData.selectedFeeHeads.map(
                                    (feeHeadId, index) => {
                                      const fee = pendingFees.find(
                                        (f) => f.feeHeadId === feeHeadId
                                      );
                                      return fee ? (
                                        <div
                                          key={feeHeadId}
                                          className="flex justify-between items-center bg-white rounded-lg p-3 shadow-sm border border-green-200 animate-slideIn"
                                          style={{
                                            animationDelay: `${index * 100}ms`,
                                          }}
                                        >
                                          <div className="flex items-center gap-3">
                                            <span className="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                              {index + 1}
                                            </span>
                                            <span className="font-medium text-gray-800">
                                              {fee.feeHead}
                                            </span>
                                          </div>
                                          <span className="font-bold text-green-900 text-lg">
                                            â‚¹
                                            {fee.pendingAmount.toLocaleString()}
                                          </span>
                                        </div>
                                      ) : null;
                                    }
                                  )}
                                </div>
                                <div className="border-t-2 border-green-400 pt-4 bg-green-200 rounded-lg p-4">
                                  <div className="flex justify-between items-center">
                                    <span className="font-bold text-green-900 text-xl flex items-center gap-2">
                                      <span>ðŸ’³</span>
                                      Total Payment:
                                    </span>
                                    <span className="font-bold text-green-900 text-2xl animate-pulse">
                                      â‚¹
                                      {formData.selectedFeeHeads
                                        .reduce((total, feeHeadId) => {
                                          const fee = pendingFees.find(
                                            (f) => f.feeHeadId === feeHeadId
                                          );
                                          return (
                                            total +
                                            (fee ? fee.pendingAmount : 0)
                                          );
                                        }, 0)
                                        .toLocaleString()}
                                    </span>
                                  </div>
                                </div>
                                <div className="mt-3 flex justify-between">
                                  <button
                                    type="button"
                                    onClick={() => {
                                      setFormData((prev) => ({
                                        ...prev,
                                        selectedFeeHeads: pendingFees.map(
                                          (f) => f.feeHeadId
                                        ),
                                      }));
                                    }}
                                    className="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition"
                                  >
                                    Select All
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const fee = pendingFees.find(
                                        (f) => f.feeHeadId === formData.selectedFeeHeads[0]
                                      );
                                      if (fee) {
                                        setFormData((prev) => ({
                                          ...prev,
                                          amount: fee.pendingAmount.toString(),
                                          feeHead: fee.feeHeadId,
                                          manualFeeHeadName: fee.feeHead,
                                          manualFeeAmount: fee.pendingAmount.toString(),
                                          paymentType: "specific",
                                        }));
                                      }
                                    }}
                                    className="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
                                  >
                                    Auto-Fill Amount
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      setFormData((prev) => ({
                                        ...prev,
                                        selectedFeeHeads: [],
                                      }));
                                    }}
                                    className="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 transition"
                                  >
                                    Clear Selection
                                  </button>
                                </div>
                              </div>
                            )}
                          </>
                        ) : (
                          <div className="text-center py-8">
                            <span className="text-xl mr-2">âœ…</span>
                            <p className="font-medium text-green-700">
                              No pending fees found for this student!
                            </p>
                          </div>
                        )}

                        <div className="mt-3 text-sm text-green-700 bg-green-100 p-2 rounded">
                          <span className="font-medium">ðŸ’¡ Tip:</span> Select
                          multiple fee heads to pay in a single transaction. Use
                          "Auto-Fill Amount" to automatically calculate the
                          total amount for selected fees.
                        </div>
                      </div>
                    </div>
                  )}

                  {/* No Pending Fees Message - Only for Specific Payment */}
                  {selectedStudent &&
                    formData.paymentType === "specific" &&
                    pendingFees.length === 0 && (
                      <div className="mt-6">
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                          <div className="flex items-center text-green-700">
                            <span className="text-xl mr-2">âœ…</span>
                            <p className="font-medium">
                              No pending fees found for this student!
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                </div>
              )}

              {/* Annual Fees Section */}
              {formData.paymentType === "annual" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ“…</span>
                    Annual Fee Payment
                  </h3>
                  <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <div className="text-center">
                      <div className="text-orange-700">
                        <span className="text-lg font-semibold">
                          Annual Fee Payment for Academic Year{" "}
                          {formData.academicYear}
                        </span>
                        <p className="text-sm mt-2">
                          This includes all annual fees such as admission fees,
                          annual development charges, etc.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Transport Fees Section */}
              {formData.paymentType === "transport" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸšŒ</span>
                    Transport Fees
                  </h3>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Route/Stop
                        </label>
                        <input
                          type="text"
                          name="transportRoute"
                          value={formData.transportRoute || ""}
                          onChange={handleInputChange}
                          placeholder="Enter route or stop name"
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Duration
                        </label>
                        <select
                          name="transportDuration"
                          value={formData.transportDuration || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500"
                        >
                          <option value="">Select Duration</option>
                          <option value="monthly">Monthly</option>
                          <option value="quarterly">Quarterly</option>
                          <option value="half-yearly">Half Yearly</option>
                          <option value="yearly">Yearly</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Hostel Fees Section */}
              {formData.paymentType === "hostel" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ </span>
                    Hostel Fees
                  </h3>
                  <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Hostel Block
                        </label>
                        <input
                          type="text"
                          name="hostelBlock"
                          value={formData.hostelBlock || ""}
                          onChange={handleInputChange}
                          placeholder="Enter hostel block"
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Room Number
                        </label>
                        <input
                          type="text"
                          name="roomNumber"
                          value={formData.roomNumber || ""}
                          onChange={handleInputChange}
                          placeholder="Enter room number"
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Fee Type
                        </label>
                        <select
                          name="hostelFeeType"
                          value={formData.hostelFeeType || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                        >
                          <option value="">Select Fee Type</option>
                          <option value="accommodation">
                            Accommodation Fees
                          </option>
                          <option value="mess">Mess Fees</option>
                          <option value="security">Security Deposit</option>
                          <option value="maintenance">Maintenance Fees</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Library Fees Section */}
              {formData.paymentType === "library" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ“–</span>
                    Library Fees
                  </h3>
                  <div className="bg-teal-50 border border-teal-200 rounded-lg p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Fee Type
                        </label>
                        <select
                          name="libraryFeeType"
                          value={formData.libraryFeeType || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                        >
                          <option value="">Select Library Fee Type</option>
                          <option value="annual">Annual Library Fee</option>
                          <option value="fine">Library Fine</option>
                          <option value="lost-book">Lost Book Charges</option>
                          <option value="membership">Library Membership</option>
                          <option value="deposit">Book Deposit</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Details
                        </label>
                        <input
                          type="text"
                          name="libraryDetails"
                          value={formData.libraryDetails || ""}
                          onChange={handleInputChange}
                          placeholder="Book name, fine details, etc."
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Lab Fees Section */}
              {formData.paymentType === "lab" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ”¬</span>
                    Laboratory Fees
                  </h3>
                  <div className="bg-pink-50 border border-pink-200 rounded-lg p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Laboratory
                        </label>
                        <select
                          name="labType"
                          value={formData.labType || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"
                        >
                          <option value="">Select Laboratory</option>
                          <option value="computer">Computer Lab</option>
                          <option value="physics">Physics Lab</option>
                          <option value="chemistry">Chemistry Lab</option>
                          <option value="biology">Biology Lab</option>
                          <option value="engineering">Engineering Lab</option>
                          <option value="language">Language Lab</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Duration
                        </label>
                        <select
                          name="labDuration"
                          value={formData.labDuration || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"
                        >
                          <option value="">Select Duration</option>
                          <option value="semester">Per Semester</option>
                          <option value="annual">Annual</option>
                          <option value="practical">
                            Per Practical Session
                          </option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Sports Fees Section */}
              {formData.paymentType === "sports" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">âš½</span>
                    Sports Fees
                  </h3>
                  <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Sports Activity
                        </label>
                        <select
                          name="sportsActivity"
                          value={formData.sportsActivity || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500"
                        >
                          <option value="">Select Sports Activity</option>
                          <option value="general">General Sports Fee</option>
                          <option value="cricket">Cricket</option>
                          <option value="football">Football</option>
                          <option value="basketball">Basketball</option>
                          <option value="tennis">Tennis</option>
                          <option value="swimming">Swimming</option>
                          <option value="athletics">Athletics</option>
                          <option value="gym">Gymnasium</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Fee Type
                        </label>
                        <select
                          name="sportsFeeType"
                          value={formData.sportsFeeType || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500"
                        >
                          <option value="">Select Fee Type</option>
                          <option value="annual">Annual Sports Fee</option>
                          <option value="tournament">Tournament Fee</option>
                          <option value="equipment">Equipment Fee</option>
                          <option value="coaching">Coaching Fee</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Development Fees Section */}
              {formData.paymentType === "development" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ—ï¸</span>
                    Development Fees
                  </h3>
                  <div className="bg-cyan-50 border border-cyan-200 rounded-lg p-4">
                    <div className="text-center">
                      <div className="text-cyan-700">
                        <span className="text-lg font-semibold">
                          Infrastructure Development Fee
                        </span>
                        <p className="text-sm mt-2">
                          This fee contributes to the development and
                          maintenance of college infrastructure, including new
                          buildings, equipment, and facility upgrades.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Miscellaneous Fees Section */}
              {formData.paymentType === "miscellaneous" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ“‹</span>
                    Miscellaneous Fees
                  </h3>
                  <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Fee Purpose
                      </label>
                      <input
                        type="text"
                        name="miscellaneousPurpose"
                        value={formData.miscellaneousPurpose || ""}
                        onChange={handleInputChange}
                        placeholder="Enter the purpose of payment"
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500"
                      />
                      <p className="text-sm text-gray-600 mt-1">
                        Please specify the purpose of this miscellaneous payment
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Admission Fees Section */}
              {formData.paymentType === "admission" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸŽ“</span>
                    Admission Fees
                  </h3>
                  <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Admission Type
                        </label>
                        <select
                          name="admissionType"
                          value={formData.admissionType || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                        >
                          <option value="">Select Admission Type</option>
                          <option value="fresh">Fresh Admission</option>
                          <option value="lateral">Lateral Entry</option>
                          <option value="transfer">Transfer Student</option>
                          <option value="re-admission">Re-admission</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Admission Category
                        </label>
                        <select
                          name="admissionCategory"
                          value={formData.admissionCategory || ""}
                          onChange={handleInputChange}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                        >
                          <option value="">Select Category</option>
                          <option value="regular">Regular Admission</option>
                          <option value="management">Management Quota</option>
                          <option value="nri">NRI Quota</option>
                          <option value="sports">Sports Quota</option>
                          <option value="cultural">Cultural Quota</option>
                        </select>
                      </div>
                    </div>
                    <div className="mt-4">
                      <div className="bg-purple-100 border border-purple-300 rounded-lg p-4">
                        <div className="flex items-center text-purple-800">
                          <span className="text-lg mr-2">ðŸ’°</span>
                          <div>
                            <div className="font-medium">Admission Fee Structure</div>
                            <div className="text-sm mt-1">
                              One-time admission charges including registration, enrollment, and administrative fees for the academic year {formData.academicYear}.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Exam Fees Section */}
              {formData.paymentType === "exam" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ“</span>
                    Exam Fees
                  </h3>
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Exam Type *
                        </label>
                        <select
                          name="examType"
                          value={formData.examType || ""}
                          onChange={handleInputChange}
                          required
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500"
                        >
                          <option value="">Select Exam Type</option>
                          <option value="mid_sem">Mid Semester Exam</option>
                          <option value="end_sem">End Semester Exam</option>
                          <option value="re_exam">Re-examination</option>
                          <option value="backlog">Backlog Exam</option>
                          <option value="improvement">Improvement Exam</option>
                          <option value="special">Special Exam</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Semester *
                        </label>
                        <select
                          name="examSemester"
                          value={formData.examSemester || ""}
                          onChange={handleInputChange}
                          required
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500"
                        >
                          <option value="">Select Semester</option>
                          <option value="1">Semester 1</option>
                          <option value="2">Semester 2</option>
                          <option value="3">Semester 3</option>
                          <option value="4">Semester 4</option>
                          <option value="5">Semester 5</option>
                          <option value="6">Semester 6</option>
                          <option value="7">Semester 7</option>
                          <option value="8">Semester 8</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Number of Subjects *
                        </label>
                        <input
                          type="number"
                          name="subjectCount"
                          value={formData.subjectCount || ""}
                          onChange={handleInputChange}
                          min="1"
                          max="10"
                          required
                          placeholder="Enter number of subjects"
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Exam Year
                        </label>
                        <input
                          type="text"
                          name="examYear"
                          value={formData.examYear || formData.academicYear}
                          onChange={handleInputChange}
                          readOnly
                          className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                        />
                      </div>
                    </div>
                    <div className="mt-4">
                      <div className="bg-red-100 border border-red-300 rounded-lg p-4">
                        <div className="flex items-center text-red-800">
                          <span className="text-lg mr-2">ðŸ“Š</span>
                          <div>
                            <div className="font-medium">Exam Fee Calculation</div>
                            <div className="text-sm mt-1">
                              Fee will be automatically calculated based on exam type, semester, and number of subjects.
                              <br />
                              <strong>Note:</strong> Re-exam and backlog fees are higher than regular exam fees.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Fee Information - Only for Specific Payment */}
              {/* {formData.paymentType === "specific" && (
                <div className="border-b border-gray-200 pb-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span className="text-xl mr-2">ðŸ’°</span>
                    Fee Details
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Fee Name *
                      </label>
                      <input
                        type="text"
                        name="manualFeeHeadName"
                        value={formData.manualFeeHeadName || ""}
                        onChange={handleInputChange}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Tuition Fee, Lab Fee, etc."
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Amount (â‚¹) *
                      </label>
                      <input
                        type="number"
                        name="manualFeeAmount"
                        value={formData.manualFeeAmount || ""}
                        onChange={(e) => {
                          handleInputChange(e);
                          setFormData((prev) => ({
                            ...prev,
                            amount: e.target.value,
                          }));
                        }}
                        min="0"
                        step="0.01"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter amount"
                        required
                      />
                    </div>
                  </div>
                </div>
              )} */}

              {/* Payment Details */}
              <div className="border-b border-gray-200 pb-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                  <span className="text-xl mr-2">ðŸ’³</span>
                  Payment Details
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Fee Name
                    </label>
                    <input
                      type="text"
                      name="feeName"
                      value={formData.feeName || ""}
                      onChange={handleInputChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Enter fee name"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Amount (â‚¹) *
                    </label>
                    <input
                      type="number"
                      name="amount"
                      value={formData.amount}
                      onChange={handleInputChange}
                      required
                      disabled={FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) || selectedStudent?.gender === 'Female'}
                      className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
                        FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) || selectedStudent?.gender === 'Female' ? 'bg-gray-100 cursor-not-allowed opacity-50' : ''
                      }`}
                      placeholder="Enter amount"
                    />
                  </div>

                  {/* Payment Method - Only show if not reserved + TFWS and not female */}
                  {!FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && selectedStudent?.gender !== 'Female' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Payment Method *
                      </label>
                      <select
                        name="paymentMethod"
                        value={formData.paymentMethod}
                        onChange={handleInputChange}
                        required
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="Cash">ðŸ’µ Cash</option>
                        <option value="Online">ðŸ–¥ï¸ Online</option>
                        <option value="Bank Transfer">ðŸ¦ Bank Transfer</option>
                        <option value="Card">ðŸ’³ Card</option>
                        <option value="UPI">ðŸ“± UPI</option>
                      </select>
                    </div>
                  )}

                  {/* UTR - Only show if not reserved + TFWS and not female and payment method requires it */}
                  {!FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && selectedStudent?.gender !== 'Female' && ['Online', 'Bank Transfer', 'Card', 'UPI'].includes(formData.paymentMethod) && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        UTR (Unique Transaction Reference) *
                      </label>
                      <input
                        type="text"
                        name="utr"
                        value={formData.utr}
                        onChange={handleInputChange}
                        required
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter UTR number"
                      />
                    </div>
                  )}

                  {/* Collected By - Only show if not reserved + TFWS and not female */}
                  {!FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && selectedStudent?.gender !== 'Female' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Collected By
                      </label>
                      <input
                        type="text"
                        name="collectedBy"
                        value={formData.collectedBy}
                        onChange={handleInputChange}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Cashier name"
                      />
                    </div>
                  )}

                  {/* Message for reserved + TFWS students or female students */}
                  {(FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && formData.tfws) || selectedStudent?.gender === 'Female' ? (
                    <div className="md:col-span-2">
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div className="flex items-center text-blue-800">
                          <span className="mr-2">ðŸŽ“</span>
                          <span className="font-medium">
                            {FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && formData.tfws
                              ? "TFWS applied to reserved category"
                              : "Female student"
                            } - Payment method, UTR, and Collected By fields are not required
                          </span>
                        </div>
                      </div>
                    </div>
                  ) : null}

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Notes (Optional)
                    </label>
                    <input
                      type="text"
                      name="remarks"
                      value={formData.remarks}
                      onChange={handleInputChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Any additional notes"
                    />
                  </div>
                </div>
              </div>

              {/* Submit Buttons */}
              <div className="flex justify-end space-x-4">
                <button
                  type="button"
                  onClick={clearForm}
                  className="px-6 py-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium transition flex items-center"
                >
                  <span className="mr-2">ðŸ”„</span>
                  Clear Form
                </button>
                <button
                  type="submit"
                  disabled={
                    loading ||
                    !formData.studentId ||
                    !formData.amount ||
                    // Don't disable for zero fees if student is female or reserved + TFWS (they have legitimate zero fees)
                    (calculatedFee.percentage === 0 && !((FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(formData.caste) && formData.tfws) || selectedStudent?.gender === 'Female')) ||
                    (formData.paymentType === "multiple" &&
                      formData.selectedFeeHeads.length === 0) ||
                    // For reserved + TFWS students or female students, payment method is required but UTR and collected by are not
                    (((FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && formData.tfws) || selectedStudent?.gender === 'Female') && !formData.paymentMethod)
                  }
                  className={`px-10 py-4 rounded-xl font-bold text-lg transition-all duration-300 transform flex items-center justify-center ${
                    loading ||
                    !formData.studentId ||
                    !formData.amount ||
                    // Don't disable for zero fees if student is female or reserved + TFWS (they have legitimate zero fees)
                    (calculatedFee.percentage === 0 && !((FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(formData.caste) && formData.tfws) || selectedStudent?.gender === 'Female')) ||
                    (formData.paymentType === "multiple" &&
                      formData.selectedFeeHeads.length === 0) ||
                    (((FEE_CONSTANTS.CASTE_CATEGORIES.RESERVED.includes(selectedStudent?.caste) && formData.tfws) || selectedStudent?.gender === 'Female') && !formData.paymentMethod)
                      ? "bg-gray-400 cursor-not-allowed"
                      : "gradient-primary text-white hover:scale-105 shadow-primary hover:shadow-xl"
                  }`}
                >
                  {loading ? (
                    <>
                      <div className="flex items-center">
                        <div className="animate-spin rounded-full h-6 w-6 border-2 border-white border-t-transparent mr-3"></div>
                        <span>Processing Payment...</span>
                        <div className="ml-3 flex space-x-1">
                          <div
                            className="w-2 h-2 bg-white rounded-full animate-bounce"
                            style={{ animationDelay: "0s" }}
                          ></div>
                          <div
                            className="w-2 h-2 bg-white rounded-full animate-bounce"
                            style={{ animationDelay: "0.1s" }}
                          ></div>
                          <div
                            className="w-2 h-2 bg-white rounded-full animate-bounce"
                            style={{ animationDelay: "0.2s" }}
                          ></div>
                        </div>
                      </div>
                    </>
                  ) : (
                    <>
                      <span className="mr-3 text-2xl">ï¿½</span>
                      <span>
                        Process{" "}
                        {formData.paymentType === "semester"
                          ? "Semester"
                          : formData.paymentType === "multiple"
                          ? "Multiple Fee"
                          : "Student"}{" "}
                        Payment
                      </span>
                      <span className="ml-3 text-xl">â†’</span>
                    </>
                  )}
                </button>
              </div>
            </form>
          </div>

          {/* Quick Stats */}
          <div className="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
              <div className="flex items-center">
                <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                  <span className="text-2xl">ðŸŽ“</span>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-600">
                    Total Students
                  </p>
                  <p className="text-2xl font-bold text-gray-900">
                    {students.length}
                  </p>
                </div>
              </div>
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
              <div className="flex items-center">
                <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                  <span className="text-2xl">ðŸ’°</span>
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-600">
                    Available Fee Heads
                  </p>
                  <p className="text-2xl font-bold text-gray-900">
                    {feeHeads.length}
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Help Section */}
          <div className="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 className="text-lg font-semibold text-blue-900 mb-3 flex items-center">
              <span className="text-xl mr-2">ðŸ’¡</span>
              Quick Guide
            </h3>
            <div className="text-sm text-blue-700 space-y-2">
              <p>
                <span className="font-medium">1.</span> Choose payment type
                (Specific Fee, Multiple Fees, Annual Fees, or Other Fee Types)
              </p>
              <p>
                <span className="font-medium">2.</span> Select the student from
                the dropdown list
              </p>
              <p>
                <span className="font-medium">3.</span> For semester payment:
                select semester and use "Pay All" button
              </p>
              <p>
                <span className="font-medium">4.</span> For multiple fees:
                select multiple fee heads using checkboxes and use "Auto-Fill
                Amount"
              </p>
              <p>
                <span className="font-medium">5.</span> For specific payment:
                review pending fees and use Quick Fill
              </p>
              <p>
                <span className="font-medium">6.</span> Enter payment details
                and click "Record Payment"
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Receipt Modal */}
      {showReceipt && (
        <ReceiptModal
          receiptData={receiptData}
          onClose={() => setShowReceipt(false)}
        />
      )}
    </>
  );
}
